# ============================================
# Caddy 配置 - HTTP 模式（临时测试）
# ============================================

# 全局选项
{
    admin off
    log {
        output file /var/log/caddy/access.log {
            roll_size 50MiB
            roll_keep 14
        }
        format json
        level INFO
    }
}

# ============================================
# HTTP 模式配置（端口 80）
# ============================================

:80 {
    # 日志格式
    log {
        output file /var/log/caddy/access.log
        format console
    }

    # ============================================
    # API 接口代理
    # ============================================
    handle /api/* /admin/* {
        reverse_proxy backend:8080 {
            health_uri /api/health
            health_interval 10s
            health_timeout 5s
            fail_duration 30s
            max_fails 3
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # ============================================
    # 健康检查端点
    # ============================================
    handle /health {
        reverse_proxy backend:8080
    }

    # ============================================
    # 前端 SPA 静态资源
    # ============================================
    handle {
        root * /usr/share/caddy/frontend

        # 1. 静态资源：文件不存在直接返回404
        @static_files {
            path *.js *.css *.png *.jpg *.jpeg *.gif *.svg *.woff *.woff2 *.ico *.webp
        }
        handle @static_files {
            file_server
        }

        # 2. SPA 路由：其他所有请求都返回 index.html
        handle {
            try_files {path} /index.html
            file_server
        }
    }

    # 安全响应头
    header {
        Cache-Control "no-cache, no-store, must-revalidate"
        Pragma "no-cache"
        Expires "0"
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "no-referrer-when-downgrade"
        X-XSS-Protection "1; mode=block"
    }
}
