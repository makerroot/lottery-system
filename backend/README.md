# Lottery System Backend

[![Go Version](https://img.shields.io/badge/Go-1.21+-00ADD8?logo=go&logoColor=white)](https://golang.org)
[![License](https://img.shields.io/badge/license-MIT-blue.svg)](LICENSE)

ä¸€ä¸ªåŸºäº Go + Gin çš„ä¼ä¸šçº§æŠ½å¥–ç³»ç»Ÿåç«¯ã€‚

## ğŸ—ï¸ æ¶æ„

æœ¬é¡¹ç›®é‡‡ç”¨**ä¸‰å±‚æ¶æ„**è®¾è®¡ï¼Œå®ç°äº†æ¸…æ™°çš„å…³æ³¨ç‚¹åˆ†ç¦»ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Handlers â”‚ HTTPå±‚ - å¤„ç†è¯·æ±‚å’Œå“åº”
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚  Services   â”‚ ä¸šåŠ¡é€»è¾‘å±‚ - æ ¸å¿ƒä¸šåŠ¡è§„åˆ™
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚Repositories â”‚ æ•°æ®è®¿é—®å±‚ - æ•°æ®åº“æ“ä½œ
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚   Database  â”‚ MySQLæ•°æ®åº“
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¦ é¡¹ç›®ç»“æ„

```
backend/
â”œâ”€â”€ config/              # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ config.go       # é…ç½®åŠ è½½
â”‚   â””â”€â”€ database.go     # æ•°æ®åº“åˆå§‹åŒ–
â”‚
â”œâ”€â”€ constants/          # å¸¸é‡å®šä¹‰
â”‚   â”œâ”€â”€ errors.go       # é”™è¯¯å¸¸é‡
â”‚   â””â”€â”€ validation.go   # éªŒè¯è§„åˆ™
â”‚
â”œâ”€â”€ errors/             # è‡ªå®šä¹‰é”™è¯¯ç±»å‹
â”‚   â””â”€â”€ errors.go       # é”™è¯¯ç±»å‹å®šä¹‰
â”‚
â”œâ”€â”€ handlers/           # HTTPå¤„ç†å™¨
â”‚   â”œâ”€â”€ admin.go        # ç®¡ç†å‘˜ç®¡ç†
â”‚   â”œâ”€â”€ auth.go         # è®¤è¯ç›¸å…³
â”‚   â”œâ”€â”€ lottery.go      # æŠ½å¥–åŠŸèƒ½
â”‚   â”œâ”€â”€ user.go         # ç”¨æˆ·ç®¡ç†
â”‚   â”œâ”€â”€ company.go      # å…¬å¸ç®¡ç†
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ middleware/         # ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ auth.go         # è®¤è¯ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ rate_limit.go   # é™æµä¸­é—´ä»¶
â”‚   â”œâ”€â”€ cors.go         # CORSå¤„ç†
â”‚   â”œâ”€â”€ request_id.go   # è¯·æ±‚IDè¿½è¸ª
â”‚   â””â”€â”€ sensitive_rate_limit.go  # æ•æ„Ÿæ“ä½œé™æµ
â”‚
â”œâ”€â”€ models/             # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ models.go       # ä¸»è¦æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ roles.go        # è§’è‰²å®šä¹‰
â”‚   â”œâ”€â”€ company.go      # å…¬å¸æ¨¡å‹
â”‚   â”œâ”€â”€ operation_log.go # æ“ä½œæ—¥å¿—
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ repositories/       # æ•°æ®è®¿é—®å±‚
â”‚   â”œâ”€â”€ user_repository.go      # ç”¨æˆ·æ•°æ®è®¿é—®
â”‚   â”œâ”€â”€ admin_repository.go     # ç®¡ç†å‘˜æ•°æ®è®¿é—®
â”‚   â”œâ”€â”€ company_repository.go   # å…¬å¸æ•°æ®è®¿é—®
â”‚   â”œâ”€â”€ prize_repository.go     # å¥–å“æ•°æ®è®¿é—®
â”‚   â””â”€â”€ draw_repository.go      # æŠ½å¥–è®°å½•æ•°æ®è®¿é—®
â”‚
â”œâ”€â”€ services/           # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”œâ”€â”€ auth_service.go         # è®¤è¯æœåŠ¡
â”‚   â”œâ”€â”€ user_service.go         # ç”¨æˆ·æœåŠ¡
â”‚   â”œâ”€â”€ admin_service.go        # ç®¡ç†å‘˜æœåŠ¡
â”‚   â”œâ”€â”€ company_service.go      # å…¬å¸æœåŠ¡
â”‚   â””â”€â”€ lottery_service.go      # æŠ½å¥–æœåŠ¡
â”‚
â”œâ”€â”€ utils/              # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ jwt.go          # JWTä»¤ç‰Œç”Ÿæˆ
â”‚   â”œâ”€â”€ password.go     # å¯†ç å“ˆå¸Œ
â”‚   â”œâ”€â”€ logger.go       # æ—¥å¿—ç³»ç»Ÿ
â”‚   â”œâ”€â”€ lottery.go      # æŠ½å¥–é€»è¾‘
â”‚   â”œâ”€â”€ validator.go    # éªŒè¯å·¥å…·
â”‚   â”œâ”€â”€ errors.go       # é”™è¯¯å·¥å…·
â”‚   â””â”€â”€ security_logger.go  # å®‰å…¨æ—¥å¿—
â”‚
â”œâ”€â”€ validators/         # è¾“å…¥éªŒè¯
â”‚   â”œâ”€â”€ validator.go     # é€šç”¨éªŒè¯å™¨
â”‚   â”œâ”€â”€ permission.go   # æƒé™éªŒè¯å™¨
â”‚   â”œâ”€â”€ sanitizer.go    # è¾“å…¥æ¸…ç†
â”‚   â””â”€â”€ password.go     # å¯†ç å¼ºåº¦éªŒè¯
â”‚
â”œâ”€â”€ response/           # APIå“åº”
â”‚   â””â”€â”€ response.go     # æ ‡å‡†åŒ–å“åº”ç»“æ„
â”‚
â””â”€â”€ main.go             # åº”ç”¨å…¥å£
```

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### 1. ä¸‰å±‚æ¶æ„
- **Handlerå±‚**: å¤„ç†HTTPè¯·æ±‚å’Œå“åº”
- **Serviceå±‚**: å®ç°ä¸šåŠ¡é€»è¾‘
- **Repositoryå±‚**: æ•°æ®åº“æ“ä½œæŠ½è±¡

### 2. æ ‡å‡†åŒ–å“åº”
æ‰€æœ‰APIå“åº”ä½¿ç”¨ç»Ÿä¸€æ ¼å¼ï¼š
```json
{
  "success": true,
  "data": {...},
  "error": null
}
```

### 3. ç»“æ„åŒ–é”™è¯¯å¤„ç†
è‡ªå®šä¹‰é”™è¯¯ç±»å‹ï¼š
- `ValidationError` - éªŒè¯é”™è¯¯
- `AuthenticationError` - è®¤è¯é”™è¯¯
- `AuthorizationError` - æˆæƒé”™è¯¯
- `NotFoundError` - èµ„æºæœªæ‰¾åˆ°
- `BusinessLogicError` - ä¸šåŠ¡é€»è¾‘é”™è¯¯

### 4. å®‰å…¨å¢å¼º
- âœ… å¯†ç å¼ºåº¦éªŒè¯ï¼ˆç®¡ç†å‘˜8ä½ï¼Œæ™®é€šç”¨æˆ·6ä½ï¼‰
- âœ… è¾“å…¥æ¸…ç†å’ŒXSSé˜²æŠ¤
- âœ… SQLæ³¨å…¥æ£€æµ‹
- âœ… æ•æ„Ÿæ“ä½œé™æµï¼ˆç™»å½•ã€å¯†ç ä¿®æ”¹ã€ç®¡ç†å‘˜åˆ›å»ºï¼‰
- âœ… è¯·æ±‚IDè¿½è¸ª
- âœ… æ“ä½œæ—¥å¿—è®°å½•

### 5. æ€§èƒ½ä¼˜åŒ–
- âœ… éšæœºæ•°ç§å­åªåˆå§‹åŒ–ä¸€æ¬¡
- âœ… æ•°æ®åº“è¿æ¥æ± 
- âœ… Redisé™æµæ”¯æŒï¼ˆå¯é€‰ï¼‰
- âœ… æŸ¥è¯¢ä¼˜åŒ–

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Go 1.18
- MySQL 5.7+ / 8.0+
- Redis 6.0+ (å¯é€‰ï¼Œç”¨äºåˆ†å¸ƒå¼é™æµ)

### å®‰è£…ä¾èµ–

```bash
go mod tidy
```

### é…ç½®

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```env
# JWTé…ç½®
JWT_SECRET=your-strong-secret-key-change-in-production

# æ•°æ®åº“é…ç½®
DATABASE_URL=user:password@tcp(localhost:3306)/lottery_system

# æœåŠ¡å™¨é…ç½®
SERVER_PORT=8080
GIN_MODE=release

# CORSé…ç½®
ALLOWED_ORIGINS=http://localhost:5173,http://localhost:5173

# Redisé…ç½®ï¼ˆå¯é€‰ï¼‰
ENABLE_REDIS=false
REDIS_ADDR=localhost:6379
REDIS_PASSWORD=
REDIS_DB=0
```

### è¿è¡Œ

```bash
# å¼€å‘ç¯å¢ƒ
go run main.go

# ç”Ÿäº§ç¯å¢ƒ
go build -o lottery-server
./lottery-server
```

## ğŸ“¡ APIç«¯ç‚¹

### å…¬å¼€ç«¯ç‚¹ï¼ˆæ— éœ€è®¤è¯ï¼‰

#### è®¤è¯
- `POST /api/register` - ç”¨æˆ·æ³¨å†Œ/ç™»å½•
- `POST /api/login` - ç»Ÿä¸€ç™»å½•æ¥å£
- `POST /admin/login` - ç®¡ç†å‘˜ç™»å½•

### ç”¨æˆ·ç«¯ç‚¹ï¼ˆéœ€è¦ç”¨æˆ·è®¤è¯ï¼‰

#### æŠ½å¥–ç›¸å…³
- `GET /api/company` - è·å–å…¬å¸ä¿¡æ¯
- `GET /api/prize-levels` - è·å–å¥–é¡¹ç­‰çº§
- `POST /api/draw` - æ‰§è¡ŒæŠ½å¥–
- `GET /api/my-prize` - è·å–æˆ‘çš„å¥–å“
- `GET /api/user-stats` - è·å–ç”¨æˆ·ç»Ÿè®¡
- `GET /api/draw-records` - è·å–æŠ½å¥–è®°å½•
- `GET /api/available-users` - è·å–å¯æŠ½å¥–ç”¨æˆ·

#### ç”¨æˆ·ç®¡ç†
- `POST /api/user/change-password` - ä¿®æ”¹å¯†ç 

### ç®¡ç†åå°ç«¯ç‚¹ï¼ˆéœ€è¦ç®¡ç†å‘˜è®¤è¯ï¼‰

#### ç®¡ç†å‘˜ç®¡ç†
- `GET /admin/admins` - è·å–ç®¡ç†å‘˜åˆ—è¡¨
- `POST /admin/admins` - åˆ›å»ºç®¡ç†å‘˜
- `PUT /admin/admins/:id` - æ›´æ–°ç®¡ç†å‘˜
- `DELETE /admin/admins/:id` - åˆ é™¤ç®¡ç†å‘˜

#### ç”¨æˆ·ç®¡ç†
- `GET /admin/users` - è·å–ç”¨æˆ·åˆ—è¡¨
- `POST /admin/users` - åˆ›å»ºå•ä¸ªç”¨æˆ·
- `POST /admin/users/batch` - æ‰¹é‡åˆ›å»ºç”¨æˆ·
- `PUT /admin/users/:id` - æ›´æ–°ç”¨æˆ·
- `DELETE /admin/users/:id` - åˆ é™¤ç”¨æˆ·

#### å…¬å¸ç®¡ç†
- `GET /admin/companies` - è·å–å…¬å¸åˆ—è¡¨
- `POST /admin/companies` - åˆ›å»ºå…¬å¸
- `PUT /admin/companies/:id` - æ›´æ–°å…¬å¸
- `GET /admin/company-stats` - è·å–å…¬å¸ç»Ÿè®¡

#### å¥–é¡¹ç®¡ç†
- `GET /admin/prize-levels` - è·å–å¥–é¡¹ç­‰çº§
- `POST /admin/prize-levels` - åˆ›å»ºå¥–é¡¹ç­‰çº§
- `PUT /admin/prize-levels/:id` - æ›´æ–°å¥–é¡¹ç­‰çº§
- `DELETE /admin/prize-levels/:id` - åˆ é™¤å¥–é¡¹ç­‰çº§
- `GET /admin/prizes/:levelId` - è·å–å¥–å“åˆ—è¡¨
- `POST /admin/prizes` - åˆ›å»ºå¥–å“
- `PUT /admin/prizes/:id` - æ›´æ–°å¥–å“
- `DELETE /admin/prizes/:id` - åˆ é™¤å¥–å“

#### ç»Ÿè®¡åˆ†æ
- `GET /admin/draw-records` - è·å–æŠ½å¥–è®°å½•
- `GET /admin/stats` - è·å–ç»Ÿè®¡æ•°æ®
- `GET /admin/operation-logs` - è·å–æ“ä½œæ—¥å¿—
- `GET /admin/operation-stats` - è·å–æ“ä½œç»Ÿè®¡

## ğŸ”’ å®‰å…¨ç‰¹æ€§

### å¯†ç ç­–ç•¥

| ç”¨æˆ·ç±»å‹ | æœ€å°é•¿åº¦ | å¤æ‚åº¦è¦æ±‚ |
|---------|---------|-----------|
| æ™®é€šç”¨æˆ· | 6ä½ | æ—  |
| ç®¡ç†å‘˜ | 8ä½ | å¤§å°å†™å­—æ¯+æ•°å­—+ç‰¹æ®Šå­—ç¬¦ä¸­è‡³å°‘2ç§ |

### é™æµç­–ç•¥

| æ“ä½œç±»å‹ | é™åˆ¶ |
|---------|------|
| ç™»å½• | æ¯åˆ†é’Ÿ5æ¬¡ï¼Œæ¯å°æ—¶20æ¬¡ |
| å¯†ç ä¿®æ”¹ | æ¯åˆ†é’Ÿ2æ¬¡ï¼Œæ¯å°æ—¶5æ¬¡ |
| ç®¡ç†å‘˜åˆ›å»º | æ¯åˆ†é’Ÿ1æ¬¡ï¼Œæ¯å°æ—¶10æ¬¡ |

### è¾“å…¥éªŒè¯
- æ‰€æœ‰ç”¨æˆ·è¾“å…¥éƒ½ç»è¿‡æ¸…ç†å’ŒéªŒè¯
- æ£€æµ‹SQLæ³¨å…¥æ¨¡å¼
- æ£€æµ‹XSSæ”»å‡»æ¨¡å¼
- éªŒè¯æ•°æ®ç±»å‹å’Œæ ¼å¼

## ğŸ“Š æ•°æ®æ¨¡å‹

### æ ¸å¿ƒæ¨¡å‹

1. **Userï¼ˆç”¨æˆ·ï¼‰**
   - ç”¨æˆ·åã€å¯†ç ã€å§“åã€æ‰‹æœºå·
   - æ‰€å±å…¬å¸
   - æŠ½å¥–çŠ¶æ€
   - è§’è‰²ï¼šuser

2. **Adminï¼ˆç®¡ç†å‘˜ï¼‰**
   - ç”¨æˆ·åã€å¯†ç 
   - æ‰€å±å…¬å¸ï¼ˆå¯é€‰ï¼Œè¶…çº§ç®¡ç†å‘˜ä¸ºNULLï¼‰
   - è¶…çº§ç®¡ç†å‘˜æ ‡å¿—
   - è§’è‰²ï¼šadmin æˆ– super_admin

3. **Companyï¼ˆå…¬å¸ï¼‰**
   - åç§°ã€ä»£ç 
   - æ¿€æ´»çŠ¶æ€

4. **PrizeLevelï¼ˆå¥–é¡¹ç­‰çº§ï¼‰**
   - åç§°ã€æè¿°
   - æ¦‚ç‡ã€åº“å­˜
   - æ’åºé¡ºåº

5. **Prizeï¼ˆå¥–å“ï¼‰**
   - åç§°ã€å›¾ç‰‡
   - æ‰€å±å¥–é¡¹ç­‰çº§

6. **DrawRecordï¼ˆæŠ½å¥–è®°å½•ï¼‰**
   - ç”¨æˆ·ã€å…¬å¸ã€å¥–é¡¹
   - IPåœ°å€ã€æ—¶é—´æˆ³

## ğŸ› ï¸ å¼€å‘å·¥å…·

### è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
go test ./...

# è¿è¡Œç‰¹å®šåŒ…çš„æµ‹è¯•
go test ./services/...

# æŸ¥çœ‹æµ‹è¯•è¦†ç›–ç‡
go test -cover ./...
```

### ä»£ç æ£€æŸ¥

```bash
# è¿è¡Œgo vet
go vet ./...

# è¿è¡Œgolangci-lintï¼ˆéœ€è¦å®‰è£…ï¼‰
golangci-lint run

# æ ¼å¼åŒ–ä»£ç 
go fmt ./...

# æ•´ç†ä¾èµ–
go mod tidy
```

### æ„å»º

```bash
# å¼€å‘æ„å»º
go build

# ç”Ÿäº§æ„å»ºï¼ˆä¼˜åŒ–ï¼‰
go build -ldflags="-s -w" -o lottery-server

# äº¤å‰ç¼–è¯‘
GOOS=linux GOARCH=amd64 go build -o lottery-server-linux
GOOS=windows GOARCH=amd64 go build -o lottery-server.exe
```

## ğŸ“ é…ç½®è¯´æ˜

### JWTé…ç½®

- `JWT_SECRET`: JWTç­¾åå¯†é’¥ï¼ˆ**å¿…é¡»ä¿®æ”¹**ï¼‰
- é»˜è®¤è¿‡æœŸæ—¶é—´ï¼š7å¤©

### æ•°æ®åº“é…ç½®

- `DATABASE_URL`: MySQLè¿æ¥å­—ç¬¦ä¸²
- è‡ªåŠ¨æ‰§è¡Œæ•°æ®åº“è¿ç§»

### Redisé…ç½®

- `ENABLE_REDIS`: æ˜¯å¦å¯ç”¨Redisï¼ˆtrue/falseï¼‰
- `REDIS_ADDR`: RedisæœåŠ¡å™¨åœ°å€
- `REDIS_PASSWORD`: Rediså¯†ç 
- `REDIS_DB`: Redisæ•°æ®åº“ç¼–å·

## ğŸ”§ ç»´æŠ¤

### æ•°æ®åº“è¿ç§»

```bash
# è‡ªåŠ¨è¿ç§»ï¼ˆåº”ç”¨å¯åŠ¨æ—¶æ‰§è¡Œï¼‰
# å¦‚éœ€æ‰‹åŠ¨è¿ç§»ï¼Œå‚è€ƒ main.go ä¸­çš„ AutoMigrate è°ƒç”¨
```

### æ—¥å¿—

æ—¥å¿—åˆ†ä¸ºä»¥ä¸‹çº§åˆ«ï¼š
- `Debug`: è°ƒè¯•ä¿¡æ¯
- `Info`: ä¸€èˆ¬ä¿¡æ¯
- `Warn`: è­¦å‘Šä¿¡æ¯
- `Error`: é”™è¯¯ä¿¡æ¯

### ç›‘æ§

å»ºè®®ç›‘æ§ä»¥ä¸‹æŒ‡æ ‡ï¼š
- APIå“åº”æ—¶é—´
- é”™è¯¯ç‡
- æ•°æ®åº“è¿æ¥æ•°
- Rediså‘½ä¸­ç‡
- é™æµè§¦å‘é¢‘ç‡

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ç”¨æˆ·åˆ†é…æŒ‡å—](USER_ASSIGNMENT_GUIDE.md)
- [åç«¯ä¼˜åŒ–è®¡åˆ’](BACKEND_OPTIMIZATION_PLAN.md)
- [ä¼˜åŒ–è¿›åº¦æŠ¥å‘Š](BACKEND_OPTIMIZATION_FINAL_REPORT.md)
- [æƒé™ç³»ç»Ÿè¯´æ˜](ROLE_BASED_AUTH.md)

## ğŸ¤ è´¡çŒ®

æ¬¢è¿è´¡çŒ®ï¼è¯·éµå¾ªä»¥ä¸‹æ­¥éª¤ï¼š

1. Fork æœ¬ä»“åº“
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. åˆ›å»º Pull Request

## ğŸ“„ è®¸å¯è¯

MIT License

## ğŸ‘¥ ä½œè€…

makerroot

---

**æœ€åæ›´æ–°**: 2026-01-24
**ç‰ˆæœ¬**: 2.0
**çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª
