<template>
  <div class="lottery-page" :style="{ '--company-color': themeColor }">
    <!-- ç™»å½•ç•Œé¢ -->
    <template v-if="!userLoggedIn && !adminLoggedIn">
    <div class="user-login-overlay">
      <div class="login-qr-container">
        <!-- å·¦ä¾§ï¼šç™»å½•è¡¨å• -->
        <div class="login-container glass">
          <div class="login-header">
            <div class="login-icon">ğŸ°</div>
            <h1 class="login-title font-display">å¹¸è¿æŠ½å¥–</h1>
            <p class="login-subtitle font-body">ç”¨æˆ·æˆ–ç®¡ç†å‘˜ç™»å½•</p>
          </div>

          <a-form layout="vertical" class="login-form">
            <a-form-item>
              <label class="form-label font-body">
                <span class="label-icon">ğŸ‘¤</span>
                ç”¨æˆ·å
              </label>
              <a-input
                v-model:value="loginForm.username"
                placeholder="è¯·è¾“å…¥ç”¨æˆ·åæˆ–ç®¡ç†å‘˜ç”¨æˆ·å"
              size="large"
              class="neon-input"
              @keyup.enter="handleLogin"
            >
              <template #prefix>
                <span>ğŸ‘¤</span>
              </template>
            </a-input>
          </a-form-item>

          <a-form-item>
            <label class="form-label font-body">
              <span class="label-icon">ğŸ”‘</span>
              å¯†ç 
            </label>
            <a-input-password
              v-model:value="loginForm.password"
              placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰"
              size="large"
              class="neon-input"
              @keyup.enter="handleLogin"
            >
              <template #prefix>
                <span>ğŸ”‘</span>
              </template>
            </a-input-password>
          </a-form-item>

          <a-form-item>
            <button
              type="button"
              @click="handleLogin"
              class="login-button font-display"
              :disabled="!loginForm.username || !loginForm.password || loginForm.password.length < 6"
              :class="{ loading: loginLoading }"
            >
              <span v-if="loginLoading" class="button-spinner"></span>
              <span>{{ loginLoading ? 'ç™»å½•ä¸­...' : 'ğŸš€ ç™»å½•' }}</span>
            </button>
          </a-form-item>
        </a-form>

        <div class="login-tips">
          <p class="tip-text font-body" style="color: #1890ff; font-weight: 600;">ğŸ’¡ æ™®é€šç”¨æˆ·å¯ç™»å½•æŸ¥çœ‹æŠ½å¥–</p>
          <p class="tip-text font-body">ğŸ‘¨â€ğŸ’¼ ç®¡ç†å‘˜å¯æ‰§è¡ŒæŠ½å¥–æ“ä½œ</p>
        </div>
      </div>

      <!-- å³ä¾§ï¼šæ‰«ç å‚ä¸ -->
      <div class="qr-register-card glass">
        <div class="qr-header">
          <div class="qr-icon">ğŸ“±</div>
          <h3 class="qr-title font-display">æ‰«ç å‚ä¸</h3>
          <p class="qr-subtitle font-body">æ‰«æäºŒç»´ç å¿«é€Ÿæ³¨å†Œ</p>
        </div>

        <div v-if="!registerQRCode" class="qr-loading">
          <a-spin size="large" />
          <p>åŠ è½½äºŒç»´ç ä¸­...</p>
        </div>

        <div v-else class="qr-content">
          <img :src="registerQRCode" alt="æ³¨å†ŒäºŒç»´ç " class="qr-image" />
          <div class="qr-instructions">
            <p class="instruction-step">
              <span class="step-number">1</span>
              æ‰“å¼€æ‰‹æœºç›¸æœºæˆ–å¾®ä¿¡æ‰«ä¸€æ‰«
            </p>
            <p class="instruction-step">
              <span class="step-number">2</span>
              æ‰«æä¸Šæ–¹äºŒç»´ç 
            </p>
            <p class="instruction-step">
              <span class="step-number">3</span>
              å¡«å†™ä¿¡æ¯å®Œæˆæ³¨å†Œ
            </p>
          </div>
        </div>
      </div>
    </div>
    </template>

    <template v-else>
    <!-- èƒŒæ™¯æ•ˆæœ -->
    <div class="neon-background">
      <div class="gradient-orb orb-cyan"></div>
      <div class="gradient-orb orb-magenta"></div>
      <div class="grid-overlay"></div>
      <div class="particles" ref="particlesRef"></div>
    </div>

    <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
    <div class="top-status-bar glass">
      <div class="status-bar-content">
        <div class="status-item">
          <span class="status-icon">
            {{ currentUserRole === 'super_admin' ? 'ğŸ‘‘' : currentUserRole === 'admin' ? 'ğŸ‘¨â€ğŸ’¼' : 'ğŸ‘¤' }}
          </span>
          <span class="status-label font-body">
            {{ currentUserRole === 'user' ? (currentUser.name || currentUser.username) : (currentUser.name || currentUser.username) }}
            <a-tag
              :color="currentUserRole === 'super_admin' ? 'gold' : currentUserRole === 'admin' ? 'cyan' : 'blue'"
              style="margin-left: 8px;"
            >
              {{ currentUserRole === 'super_admin' ? 'è¶…çº§ç®¡ç†å‘˜' : currentUserRole === 'admin' ? 'ç®¡ç†å‘˜' : 'ç”¨æˆ·' }}
            </a-tag>
          </span>
        </div>
        <div class="status-divider"></div>
        <div class="status-item">
          <span class="status-icon">ğŸ†</span>
          <span class="status-label font-body">æœ¬åœºä¸­å¥–</span>
          <span class="status-value font-display">{{ drawRecords.length }}</span>
        </div>
        <div class="status-divider"></div>
        <div class="status-item">
          <span class="status-icon">ğŸ‘¥</span>
          <span class="status-label font-body">å‚ä¸äººæ•°</span>
          <span class="status-value font-display">{{ userStats.total_users || 0 }}</span>
        </div>
        <div class="status-divider"></div>
        <a-tooltip title="ç‚¹å‡»ä¿®æ”¹ç™»å½•å¯†ç " placement="bottom">
          <a-button
            type="primary"
            size="small"
            @click="showChangePasswordModal"
            style="display: flex; align-items: center; gap: 4px;"
          >
            <span>ğŸ”</span>
            <span>ä¿®æ”¹å¯†ç </span>
          </a-button>
        </a-tooltip>
        <div class="status-divider"></div>
        <div class="status-item logout-action" @click="handleLogout" style="cursor: pointer;">
          <span class="status-icon">ğŸšª</span>
          <span class="status-label font-body">é€€å‡º</span>
        </div>
      </div>
    </div>

    <!-- ä¿®æ”¹å¯†ç å¼¹çª— -->
    <a-modal
      v-model:open="changePasswordVisible"
      title="ä¿®æ”¹å¯†ç "
      :footer="null"
      width="400px"
    >
      <a-form :model="passwordForm" layout="vertical" @finish="handleChangePassword">
        <a-form-item>
          <label class="form-label font-body">
            <span class="label-icon">ğŸ”‘</span>
            å½“å‰å¯†ç 
          </label>
          <a-input-password
            v-model:value="passwordForm.oldPassword"
            placeholder="è¯·è¾“å…¥å½“å‰å¯†ç "
            size="large"
            class="neon-input"
          />
        </a-form-item>

        <a-form-item>
          <label class="form-label font-body">
            <span class="label-icon">ğŸ”’</span>
            æ–°å¯†ç 
          </label>
          <a-input-password
            v-model:value="passwordForm.newPassword"
            placeholder="è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰"
            size="large"
            class="neon-input"
          />
        </a-form-item>

        <a-form-item>
          <label class="form-label font-body">
            <span class="label-icon">âœ“</span>
            ç¡®è®¤å¯†ç 
          </label>
          <a-input-password
            v-model:value="passwordForm.confirmPassword"
            placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç "
            size="large"
            class="neon-input"
          />
        </a-form-item>

        <a-form-item>
          <a-button type="primary" html-type="submit" :loading="changePasswordLoading" block size="large">
            ç¡®è®¤ä¿®æ”¹
          </a-button>
          <a-button style="margin-top: 8px;" block size="large" @click="changePasswordVisible = false">
            å–æ¶ˆ
          </a-button>
        </a-form-item>
      </a-form>
    </a-modal>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="top-status-bar glass">
      <div class="status-bar-content">
        <div class="status-item">
          <span class="status-icon">ğŸ†</span>
          <span class="status-label font-body">æœ¬åœºä¸­å¥–</span>
          <span class="status-value font-display">{{ drawRecords.length }}</span>
        </div>
        <div class="status-divider"></div>
        <div class="status-item">
          <span class="status-icon">ğŸ‘¥</span>
          <span class="status-label font-body">å‚ä¸äººæ•°</span>
          <span class="status-value font-display">{{ userStats.total_users || 0 }}</span>
        </div>
        <div class="status-divider"></div>
        <div class="status-item">
          <span class="status-icon">â±ï¸</span>
          <span class="status-label font-body">æ´»åŠ¨çŠ¶æ€</span>
          <span class="status-indicator live">è¿›è¡Œä¸­</span>
        </div>
      </div>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="lottery-content">
      <!-- å·¦ä¾§ä¸»èˆå° -->
      <div class="stage-area">
        <div class="lottery-display">
          <div class="display-container glass neon-border-flow mega-display">
            <!-- ç­‰å¾…å’ŒæŠ½å¥–çŠ¶æ€ -->
            <div v-if="!showResult" class="drawing-animation">
              <!-- ç”¨æˆ·åˆ—è¡¨ï¼šåªåœ¨æŠ½å¥–ä¸­æ˜¾ç¤º -->
              <div v-if="drawing" class="rolling-container" ref="rollingContainerRef">
                <div class="rolling-track" ref="rollingTrackRef">
                  <div
                    v-for="(user, index) in displayUsers"
                    :key="`${index}-${user.name}`"
                    class="user-item"
                    :data-index="index"
                  >
                    <div class="user-name font-display">{{ user.name }}</div>
                    <div class="user-phone font-mono">{{ maskPhone(user.phone) }}</div>
                  </div>
                </div>
              </div>

              <!-- é«˜äº®æ¡†ï¼šåªåœ¨æŠ½å¥–ä¸­æ˜¾ç¤º -->
              <div v-if="drawing" class="highlight-frame">
                <div class="highlight-indicator"></div>
              </div>

              <!-- ç­‰å¾…æç¤ºï¼šåªåœ¨å‡†å¤‡çŠ¶æ€æ˜¾ç¤º -->
              <div v-if="!drawing" class="waiting-overlay">
                <div class="waiting-icon">ğŸ°</div>
                <h2 class="waiting-title font-display">å‡†å¤‡æŠ½å¥–</h2>
              </div>

              <!-- æŠ½å¥–ä¸­çš„åœæ­¢æŒ‰é’® -->
              <div v-if="drawing" class="drawing-overlay"></div>
              <button
                v-if="drawing"
                @click="handleStopDrawing"
                class="stop-draw-btn font-display mega-btn"
              >
                ğŸ›‘ åœæ­¢æŠ½å¥–
              </button>
            </div>

            <!-- ä¸­å¥–ç»“æœ -->
            <div v-if="showResult" class="result-showcase">
              <div class="result-icon">ğŸ</div>
              <h2 class="result-title font-display">{{ successText }}</h2>

              <div class="winners-list">
                <div
                  v-for="(winner, index) in currentWinners"
                  :key="winner.id"
                  class="winner-card winner-card-mega glass"
                  :style="{ animationDelay: `${index * 0.15}s` }"
                >
                  <div class="winner-avatar font-display">
                    {{ (winner.user?.name || 'æœªçŸ¥')[0] }}
                  </div>
                  <div class="winner-info">
                    <div class="winner-name font-display">{{ winner.user?.name }}</div>
                    <div class="winner-phone font-mono">{{ maskPhone(winner.user?.phone) }}</div>
                  </div>
                  <div class="winner-prize">
                    <div class="prize-level">{{ winner.level?.name }}</div>
                    <div class="prize-name">{{ winner.prize?.name }}</div>
                  </div>
                </div>
              </div>

              <button @click="resetDraw" class="continue-draw-btn font-display">
                <span class="btn-icon">ğŸ°</span>
                <span class="btn-text">ç»§ç»­æŠ½å¥–</span>
                <span class="btn-arrow">â†’</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- å³ä¾§æ§åˆ¶é¢æ¿ï¼ˆä»…ç®¡ç†å‘˜å¯è§ï¼‰ -->
      <div v-if="!showResult && adminLoggedIn" class="controls-area">
        <div class="config-card glass control-panel">
          <div class="config-header">
            <h3 class="config-title font-display">ğŸ® æ§åˆ¶é¢æ¿</h3>
          </div>

          <div class="config-form">
            <!-- å¥–é¡¹é€‰æ‹© -->
            <div class="form-group">
              <label class="form-label font-body">é€‰æ‹©å¥–é¡¹ç­‰çº§</label>
              <a-select
                v-model:value="selectedLevelId"
                placeholder="è¯·é€‰æ‹©è¦æŠ½å–çš„å¥–é¡¹"
                size="large"
                class="neon-select"
                :status="!selectedLevelId && drawAttempted ? 'error' : ''"
              >
                <a-select-option
                  v-for="level in availablePrizeLevels"
                  :key="level.id"
                  :value="level.id"
                >
                  <div class="level-option">
                    <div class="level-main">
                      <span class="level-name font-display">{{ level.name }}</span>
                      <a-tag :color="getLevelColor(level.name)" class="level-tag">
                        {{ getLevelLabel(level.name) }}
                      </a-tag>
                    </div>
                    <div class="level-stock">
                      <span class="stock-text">
                        å‰©ä½™: <strong :style="{ color: getStockColor(level) }">
                          {{ level.total_stock - level.used_stock }}
                        </strong> / {{ level.total_stock }}
                      </span>
                    </div>
                  </div>
                </a-select-option>
              </a-select>
              <div v-if="!selectedLevelId && drawAttempted" class="form-error">
                è¯·é€‰æ‹©å¥–é¡¹ç­‰çº§
              </div>
            </div>

            <!-- æŠ½å–äººæ•° -->
            <div class="form-group">
              <label class="form-label font-body">æŠ½å–äººæ•°</label>
              <div class="count-selector">
                <a-input-number
                  v-model:value="drawCount"
                  :min="1"
                  :max="maxDrawCount"
                  size="large"
                  class="neon-input-number"
                />
                <div class="quick-counts">
                  <button
                    v-for="num in [1, 3, 5, 10]"
                    :key="num"
                    class="quick-count-btn font-display"
                    :class="{ active: drawCount === num }"
                    @click="drawCount = num"
                    :disabled="num > maxDrawCount"
                  >
                    {{ num }}äºº
                  </button>
                </div>
              </div>
              <div class="form-tip font-body">
                ğŸ’¡ æœ€å¤šå¯æŠ½ <strong>{{ maxDrawCount }}</strong> äºº
              </div>
            </div>

            <!-- å¼€å§‹æŠ½å¥–æŒ‰é’® -->
            <div class="draw-actions">
              <button
                @click="handleDraw"
                class="draw-button font-display mega-draw-btn"
                :disabled="!selectedLevelId || !drawCount || drawing"
                :class="{ drawing: drawing }"
              >
                <span v-if="drawing" class="button-spinner"></span>
                <span>{{ drawing ? 'æŠ½å¥–ä¸­...' : 'ğŸ° å¼€å§‹æŠ½å¥–' }}</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- æ™®é€šç”¨æˆ·åŒºåŸŸï¼ˆç”¨æˆ·ç™»å½•ä½†ä¸æ˜¯ç®¡ç†å‘˜æ—¶æ˜¾ç¤ºï¼‰ -->
      <div v-if="!showResult && userLoggedIn && !adminLoggedIn" class="controls-area">
        <div class="config-card glass control-panel user-info-panel">
          <div class="config-header">
            <h3 class="config-title font-display">ğŸ“‹ æŠ½å¥–ä¿¡æ¯</h3>
          </div>

          <div class="user-info-content">
            <div class="info-item">
              <span class="info-icon">ğŸ‘¥</span>
              <div class="info-details">
                <div class="info-label">å‚ä¸äººæ•°</div>
                <div class="info-value font-display">{{ userStats.total_users || 0 }}</div>
              </div>
            </div>

            <div class="info-item">
              <span class="info-icon">ğŸ¯</span>
              <div class="info-details">
                <div class="info-label">å·²æŠ½å¥–</div>
                <div class="info-value font-display">{{ userStats.drawn_users || 0 }}</div>
              </div>
            </div>

            <div class="info-item">
              <span class="info-icon">â³</span>
              <div class="info-details">
                <div class="info-label">å¾…æŠ½å¥–</div>
                <div class="info-value font-display">{{ userStats.undrawn_users || 0 }}</div>
              </div>
            </div>

            <div class="user-notice-banner">
              <span class="notice-icon">ğŸ“‹</span>
              <p class="notice-text font-body">
                æ‚¨å½“å‰ä»¥ç”¨æˆ·èº«ä»½ç™»å½•ï¼Œå¯æŸ¥çœ‹æŠ½å¥–ä¿¡æ¯ã€‚æŠ½å¥–ç”±ç®¡ç†å‘˜ä¸»æŒã€‚
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- åº•éƒ¨ä¸­å¥–æ—¶é—´çº¿ -->
      <div v-if="drawRecords.length > 0" class="timeline-area">
        <div class="timeline-header">
          <h3 class="timeline-title font-display">ğŸ† ä¸­å¥–å†å²</h3>
          <div class="timeline-controls">
            <a-tag color="success" class="count-badge">{{ drawRecords.length }}äºº</a-tag>
            <button
              @click="toggleAutoScroll"
              class="scroll-toggle font-body"
              :class="{ 'paused': !isAutoScrolling }"
            >
              {{ isAutoScrolling ? 'â¸' : 'â–¶ï¸' }}
            </button>
          </div>
        </div>
        <div
          class="winners-timeline"
          ref="timelineContainerRef"
          @mouseenter="pauseAutoScroll"
          @mouseleave="resumeAutoScroll"
        >
          <div class="timeline-track" ref="timelineRef">
            <div
              v-for="record in drawRecords.slice().reverse()"
              :key="record.id"
              class="timeline-item glass"
            >
              <div class="timeline-avatar font-display">
                {{ (record.user?.name || 'æœªçŸ¥')[0] }}
              </div>
              <div class="timeline-info">
                <div class="timeline-name font-display">{{ record.user?.name }}</div>
                <div class="timeline-phone font-mono">{{ maskPhone(record.user?.phone) }}</div>
              </div>
              <div class="timeline-prize">
                <div class="timeline-level">{{ record.level?.name }}</div>
                <div class="timeline-prize-name">{{ record.prize?.name }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    </template>
  </div>
</template>

<script setup>
import { ref, onMounted, onUnmounted, computed, watch } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { message } from 'ant-design-vue'
import api from '../utils/api'
import request from '../utils/request'
import { loadCompanyConfig, useCompany, defaultConfig } from '../utils/company'
import { useUser } from '../utils/user'

const route = useRoute()
const router = useRouter()
const { userLoggedIn, currentUser, setUser, clearUser } = useUser()

// ç®¡ç†å‘˜ç™»å½•çŠ¶æ€
const adminLoggedIn = ref(!!localStorage.getItem('admin_token'))
const adminUser = ref(null)

// å½“å‰ç™»å½•ç”¨æˆ·èº«ä»½ï¼ˆuser/admin/super_adminï¼‰
const currentUserRole = ref('guest')

// ç™»å½•è¡¨å•ï¼ˆç»Ÿä¸€ï¼‰
const loginForm = ref({
  username: '',
  password: ''
})
const loginLoading = ref(false)

// ä¿®æ”¹å¯†ç 
const changePasswordVisible = ref(false)
const changePasswordLoading = ref(false)
const passwordForm = ref({
  oldPassword: '',
  newPassword: '',
  confirmPassword: ''
})

// æ³¨å†ŒäºŒç»´ç 
const registerQRCode = ref('')

// ç¡®è®¤å¯†ç éªŒè¯
const validateConfirmPassword = async (_rule, value) => {
  if (value !== passwordForm.value.newPassword) {
    return Promise.reject('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´')
  }
  return Promise.resolve()
}

// æ˜¾ç¤ºä¿®æ”¹å¯†ç å¼¹çª—
const showChangePasswordModal = () => {
  passwordForm.value = {
    oldPassword: '',
    newPassword: '',
    confirmPassword: ''
  }
  changePasswordVisible.value = true
}

// ä¿®æ”¹å¯†ç 
const handleChangePassword = async () => {
  if (!passwordForm.value.oldPassword) {
    return
  }
  if (!passwordForm.value.newPassword) {
    return
  }
  if (passwordForm.value.newPassword.length < 6) {
    return
  }
  if (passwordForm.value.newPassword !== passwordForm.value.confirmPassword) {
    return
  }

  changePasswordLoading.value = true
  try {
    if (currentUserRole.value === 'user') {
      // æ™®é€šç”¨æˆ·ä¿®æ”¹å¯†ç 
      await api.post('/api/user/change-password', {
        old_password: passwordForm.value.oldPassword,
        new_password: passwordForm.value.newPassword
      })
    } else {
      // ç®¡ç†å‘˜ä¿®æ”¹å¯†ç 
      await request.post('/admin/change-password', {
        old_password: passwordForm.value.oldPassword,
        new_password: passwordForm.value.newPassword
      })
    }
    message.success('å¯†ç ä¿®æ”¹æˆåŠŸï¼Œè¯·é‡æ–°ç™»å½•')
    changePasswordVisible.value = false
    // æ¸…ç©ºç™»å½•çŠ¶æ€ï¼Œé‡æ–°ç™»å½•
    setTimeout(() => {
      handleLogout()
    }, 1000)
    message.error(error.response?.data?.error || 'ä¿®æ”¹å¯†ç å¤±è´¥ï¼Œè¯·æ£€æŸ¥å½“å‰å¯†ç æ˜¯å¦æ­£ç¡®')
  } finally {
    changePasswordLoading.value = false
  }
}

// ç®¡ç†å‘˜ç™»å½•å¤„ç†ï¼ˆä»…æ”¯æŒç®¡ç†å‘˜å’Œè¶…çº§ç®¡ç†å‘˜ï¼‰
const handleLogin = async () => {
  if (!loginForm.value.username) {
    return
  }

  if (!loginForm.value.password) {
    return
  }

  if (loginForm.value.password.length < 6) {
    return
  }

  loginLoading.value = true
  try {
    // è·å–å…¬å¸ä»£ç ï¼ˆURLå‚æ•°ä¼˜å…ˆçº§æœ€é«˜ï¼‰
    // æ³¨æ„ï¼šå‚æ•°å¯èƒ½åœ¨hashä¸­ï¼Œå¦‚ï¼š#/lottery?company=4000
    let urlCompanyCode = null

    // å…ˆå°è¯•ä»hashä¸­è·å–å‚æ•°
    if (window.location.hash.includes('?')) {
      const hashParts = window.location.hash.split('?')
      if (hashParts.length > 1) {
        const hashParams = new URLSearchParams(hashParts[1])
        urlCompanyCode = hashParams.get('company')
      }
    }

    // å¦‚æœhashä¸­æ²¡æœ‰ï¼Œå°è¯•ä»searchä¸­è·å–
    if (!urlCompanyCode && window.location.search) {
      const urlParams = new URLSearchParams(window.location.search)
      urlCompanyCode = urlParams.get('company')
    }

    console.log('handleLogin - URL hash:', window.location.hash)
    console.log('handleLogin - extracted company code:', urlCompanyCode)

    // ä½¿ç”¨URLå‚æ•°ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨å½“å‰å·²ä¿å­˜çš„ï¼Œæœ€åæ‰ä½¿ç”¨é»˜è®¤å€¼
    let companyCode = urlCompanyCode || currentCompanyCode.value || 'DEFAULT'

    // ä½¿ç”¨ç»Ÿä¸€ç™»å½•æ¥å£ï¼ˆæ”¯æŒç”¨æˆ·å’Œç®¡ç†å‘˜ï¼‰
    const response = await api.post('/api/login', {
      username: loginForm.value.username,
      password: loginForm.value.password
    }, {
      params: { company_code: companyCode }
    })

    // æ ¹æ®ç™»å½•ç±»å‹å¤„ç†
    if (response.user_type === 'user') {
      // æ™®é€šç”¨æˆ·ç™»å½•
      setUser(response.user)
      currentUserRole.value = 'user'
      message.success(`ğŸ‰ æ¬¢è¿å›æ¥ï¼Œ${response.user.name}ï¼`)
    } else if (response.user_type === 'admin' || response.user_type === 'super_admin') {
      // ç®¡ç†å‘˜æˆ–è¶…çº§ç®¡ç†å‘˜ç™»å½•
      localStorage.setItem('admin_token', response.token)
      localStorage.setItem('admin_user', JSON.stringify(response.user))
      adminLoggedIn.value = true
      adminUser.value = response.user
      currentUserRole.value = response.user_type

      if (response.user_type === 'super_admin') {
        message.success('ğŸ‘‘ è¶…çº§ç®¡ç†å‘˜ç™»å½•æˆåŠŸï¼')
      } else {
        message.success('ğŸ‘¨â€ğŸ’¼ ç®¡ç†å‘˜ç™»å½•æˆåŠŸï¼')
      }
    }

    // è®¾ç½®å…¬å¸ä»£ç ï¼šURLå‚æ•°ä¼˜å…ˆï¼Œå…¶æ¬¡ä½¿ç”¨ç®¡ç†å‘˜å…³è”çš„å…¬å¸ï¼Œæœ€åä½¿ç”¨é»˜è®¤å…¬å¸
    if (urlCompanyCode) {
      // URLå‚æ•°ä¼˜å…ˆçº§æœ€é«˜ï¼Œä¿æŒä¸å˜
      // currentCompanyCode å·²ç»åœ¨ onMounted ä¸­è®¾ç½®äº†
      console.log('handleLogin (admin) - keeping URL company code:', urlCompanyCode) // è°ƒè¯•æ—¥å¿—
    } else if (response.user.company) {
      // å¦‚æœURLæ²¡æœ‰æŒ‡å®šï¼Œä½¿ç”¨ç®¡ç†å‘˜å…³è”çš„å…¬å¸
      currentCompanyCode.value = response.user.company.code
      setCompanyCode(response.user.company.code)
      console.log('handleLogin (admin) - using admin company:', response.user.company.code) // è°ƒè¯•æ—¥å¿—
    } else {
      // ç®¡ç†å‘˜æ²¡æœ‰å…³è”å…¬å¸ï¼Œä½¿ç”¨é»˜è®¤å…¬å¸
      currentCompanyCode.value = 'DEFAULT'
      setCompanyCode('DEFAULT')
      console.log('handleLogin (admin) - using DEFAULT') // è°ƒè¯•æ—¥å¿—
    }

    console.log('handleLogin (admin) - final currentCompanyCode:', currentCompanyCode.value) // è°ƒè¯•æ—¥å¿—

    await loadCompanyConfig(currentCompanyCode.value)
    await fetchData()
  } catch (error) {
    if (error.response && error.response.status === 401) {
      message.error('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯')
    } else {
      message.error('ç™»å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•')
    }
  } finally {
    loginLoading.value = false
  }
}

// å¤„ç†ç”¨æˆ·é€€å‡º
const handleLogout = () => {
  if (adminLoggedIn.value) {
    // ç®¡ç†å‘˜é€€å‡º
    localStorage.removeItem('admin_token')
    localStorage.removeItem('admin_user')
    adminLoggedIn.value = false
    adminUser.value = null
  } else {
    // ç”¨æˆ·é€€å‡º
    clearUser()
  }
  currentUserRole.value = 'guest'
  message.info('å·²é€€å‡ºç™»å½•')
  router.push('/')
}

const particlesRef = ref(null)
const confettiRef = ref(null)
const timelineRef = ref(null)
const timelineContainerRef = ref(null)
const rollingContainerRef = ref(null)
const rollingTrackRef = ref(null)

// å½“å‰ç™»å½•çš„å…¬å¸ä»£ç 
const currentCompanyCode = ref('')

// å…¬å¸é…ç½®
const {
  companyConfig,
  companyCode,
  setCompanyCode,
  themeColor,
  bgColor,
  title,
  subtitle,
  drawButtonText,
  successText
} = useCompany()

// æ•°æ®
const prizeLevels = ref([])
const userStats = ref({})
const drawRecords = ref([])
const currentWinners = ref([])
const drawing = ref(false)
const showResult = ref(false)
const displayUsers = ref([])
const drawAttempted = ref(false)

// æ–°å¢ï¼šç‰¹æ•ˆæ§åˆ¶
const showFlash = ref(false)
const showShake = ref(false)
const showConfetti = ref(false)

// æ»šåŠ¨åŠ¨ç”»å‡½æ•°
const startRolling = () => {
  if (rollingInterval.value || !rollingContainerRef.value) return

  rollingInterval.value = setInterval(() => {
    const container = rollingContainerRef.value
    if (!container) return

    // å‘å·¦æ»šåŠ¨
    container.scrollBy({ left: rollingSpeed, behavior: 'auto' })
  }, rollingDelay)
}

const stopRolling = () => {
  if (rollingInterval.value) {
    clearInterval(rollingInterval.value)
    rollingInterval.value = null
  }
}

// æŠ½å¥–é…ç½®
const selectedLevelId = ref(null)
const drawCount = ref(1)

// æ»šåŠ¨åŠ¨ç”»æ§åˆ¶
const rollingInterval = ref(null)
const rollingSpeed = 10 // æ¯æ¬¡æ»šåŠ¨çš„åƒç´ ï¼ˆæ›´å¿«çš„é€Ÿåº¦ï¼‰
const rollingDelay = 16 // æ»šåŠ¨é—´éš”ï¼ˆçº¦60fpsï¼‰

// è‡ªåŠ¨æ»šåŠ¨æ§åˆ¶
const isAutoScrolling = ref(true)
const autoScrollInterval = ref(null)
const scrollSpeed = 30 // æ¯æ¬¡æ»šåŠ¨çš„åƒç´ 
const scrollDelay = 100 // æ»šåŠ¨é—´éš”ï¼ˆæ¯«ç§’ï¼‰

// å¯ç”¨çš„å¥–é¡¹ç­‰çº§
const availablePrizeLevels = computed(() => {
  return prizeLevels.value.filter(level =>
    level.is_active && (level.total_stock - level.used_stock) > 0
  )
})

// æœ€å¤§å¯æŠ½å–äººæ•°ï¼ˆæ ¹æ®å½“å‰å¥–é¡¹çš„å‰©ä½™åº“å­˜ï¼‰
const maxDrawCount = computed(() => {
  if (!selectedLevelId.value) return 1
  const level = prizeLevels.value.find(l => l.id === selectedLevelId.value)
  if (!level) return 1
  return level.total_stock - level.used_stock
})

// åŠ è½½å…¬å¸é…ç½®
const refreshConfig = async () => {
  await loadCompanyConfig()
  // åŠ¨æ€ç”Ÿæˆå¸¦é€æ˜åº¦çš„é¢œè‰²å˜é‡
  updateThemeColorVariables()
}

// åŠ¨æ€ç”Ÿæˆå¸¦é€æ˜åº¦çš„ä¸»é¢˜é¢œè‰²å˜é‡
const updateThemeColorVariables = () => {
  const color = themeColor.value || '#00fff5'
  const bgColorValue = bgColor.value || '#0a0f14'

  // è¾…åŠ©å‡½æ•°ï¼šå°†hexè½¬æ¢ä¸ºrgba
  const hexToRgba = (hex, alpha) => {
    const r = parseInt(hex.slice(1, 3), 16)
    const g = parseInt(hex.slice(3, 5), 16)
    const b = parseInt(hex.slice(5, 7), 16)
    return `rgba(${r}, ${g}, ${b}, ${alpha})`
  }

  // è®¾ç½®CSSå˜é‡
  const root = document.documentElement
  root.style.setProperty('--company-color', color)
  root.style.setProperty('--company-color-bg', bgColorValue)  // ä½¿ç”¨å…¬å¸é…ç½®çš„èƒŒæ™¯è‰²

  root.style.setProperty('--company-color-03', hexToRgba(color, 0.03))
  root.style.setProperty('--company-color-10', hexToRgba(color, 0.1))
  root.style.setProperty('--company-color-15', hexToRgba(color, 0.15))
  root.style.setProperty('--company-color-20', hexToRgba(color, 0.2))
  root.style.setProperty('--company-color-30', hexToRgba(color, 0.3))
  root.style.setProperty('--company-color-40', hexToRgba(color, 0.4))
  root.style.setProperty('--company-color-50', hexToRgba(color, 0.5))
  root.style.setProperty('--company-color-60', hexToRgba(color, 0.6))
}

// ç›‘å¬ä¸»é¢˜é¢œè‰²å˜åŒ–
watch(themeColor, () => {
  updateThemeColorVariables()
}, { immediate: true })

// ç›‘å¬èƒŒæ™¯é¢œè‰²å˜åŒ–
watch(bgColor, () => {
  updateThemeColorVariables()
}, { immediate: true })

// è·å–å¥–é¡¹åˆ—è¡¨
const fetchPrizeLevels = async () => {
  try {
    if (!currentCompanyCode.value) return
    const data = await api.get(`/api/prize-levels?company_code=${currentCompanyCode.value}`)
    prizeLevels.value = data
  } catch (error) {
    message.error('è·å–å¥–é¡¹åˆ—è¡¨å¤±è´¥')
  }
}

// åŠ è½½ç”¨æˆ·ç»Ÿè®¡
const loadUserStats = async () => {
  try {
    if (!currentCompanyCode.value) return
    const data = await api.get(`/api/user-stats?company_code=${currentCompanyCode.value}`)
    userStats.value = data
  } catch (error) {
    // é™é»˜å¤„ç†é”™è¯¯
  }
}

// è·å–æŠ½å¥–è®°å½•
const fetchDrawRecords = async () => {
  try {
    if (!currentCompanyCode.value) return
    const data = await api.get(`/api/draw-records?company_code=${currentCompanyCode.value}`)
    drawRecords.value = data || []
  } catch (error) {
    message.error('è·å–ä¸­å¥–è®°å½•å¤±è´¥')
  }
}

// è·å–æ³¨å†ŒäºŒç»´ç 
const fetchRegisterQRCode = async () => {
  try {
    if (!currentCompanyCode.value) return

    const data = await api.get(`/api/qr-register?company_code=${currentCompanyCode.value}`)
    registerQRCode.value = data.qr_code
  } catch (error) {
    console.error('è·å–æ³¨å†ŒäºŒç»´ç å¤±è´¥:', error)
    // é™é»˜å¤±è´¥ï¼Œä¸å½±å“å…¶ä»–åŠŸèƒ½
  }
}

// åŠ è½½æ‰€æœ‰æ•°æ®ï¼ˆå¥–é¡¹ã€ç»Ÿè®¡ã€è®°å½•ï¼‰
const fetchData = async () => {
  try {
    await Promise.all([
      fetchPrizeLevels(),
      loadUserStats(),
      fetchDrawRecords()
    ])
  } catch (error) {
    // Error handled
  }
}

// åˆ›å»ºæ˜¾ç¤ºç”¨æˆ·åˆ—è¡¨ï¼ˆä»åç«¯è·å–çœŸå®ç”¨æˆ·ï¼‰
const createDisplayUsers = async () => {
  try {
    if (!currentCompanyCode.value) {
      // æœªç™»å½•æ—¶é™é»˜è¿”å›ï¼Œä¸æ˜¾ç¤ºæç¤ºä¿¡æ¯
      return
    }

    // è·å–æœªæŠ½å¥–çš„ç”¨æˆ·åˆ—è¡¨
    const data = await api.get(`/api/available-users?company_code=${currentCompanyCode.value}`)

    if (!data || data.length === 0) {
      // æ²¡æœ‰ç”¨æˆ·æ•°æ®ï¼Œæ˜¾ç¤ºæç¤º
      displayUsers.value = []
      message.info('æš‚æ— å¯æŠ½å¥–ç”¨æˆ·ï¼Œè¯·å…ˆæ·»åŠ ç”¨æˆ·')
      return
    }

    // å¤åˆ¶çœŸå®ç”¨æˆ·æ•°æ®å¤šæ¬¡ï¼Œåˆ›å»ºè¶³å¤Ÿçš„æ»šåŠ¨å†…å®¹
    const users = []
    const repeatCount = Math.max(50, Math.ceil(350 / data.length))
    for (let i = 0; i < repeatCount; i++) {
      users.push(...data)
    }
    displayUsers.value = users
  } catch (error) {
    // æœªç™»å½•æˆ–å…¶ä»–é”™è¯¯æ—¶é™é»˜å¤„ç†
    console.error('è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error)
    displayUsers.value = []
  }
}

// åˆ›å»ºç²’å­æ•ˆæœ
const createParticles = () => {
  const container = particlesRef.value
  if (!container) return

  for (let i = 0; i < 20; i++) {
    const particle = document.createElement('div')
    particle.className = 'particle'
    particle.style.left = `${Math.random() * 100}%`
    particle.style.top = `${Math.random() * 100}%`
    particle.style.animationDelay = `${Math.random() * 5}s`
    particle.style.animationDuration = `${5 + Math.random() * 10}s`
    container.appendChild(particle)
  }
}

// æŠ½å¥–
const handleDraw = async () => {
  if (!selectedLevelId.value) {
    drawAttempted.value = true
    return
  }
  if (!drawCount.value || drawCount.value <= 0) {
    return
  }

  // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
  if (!userLoggedIn.value && !adminLoggedIn.value) {
    // æœªç™»å½•æ—¶é™é»˜è¿”å›ï¼Œç™»å½•ç•Œé¢ä¼šè‡ªåŠ¨æ˜¾ç¤º
    return
  }

  // åœ¨æŠ½å¥–å‰é‡æ–°åˆ›å»ºç”¨æˆ·åˆ—è¡¨ï¼Œç¡®ä¿æ•°æ®æ˜¯æœ€æ–°çš„
  await createDisplayUsers()

  // ç¡®è®¤æœ‰ç”¨æˆ·æ•°æ®
  if (!displayUsers.value || displayUsers.value.length === 0) {
    message.error('ç”¨æˆ·åˆ—è¡¨ä¸ºç©ºï¼Œæ— æ³•å¼€å§‹æŠ½å¥–')
    return
  }

  const level = prizeLevels.value.find(l => l.id === selectedLevelId.value)
  if (!level) {
    message.error('å¥–é¡¹ä¸å­˜åœ¨')
    return
  }
  const available = level.total_stock - level.used_stock
  if (available < drawCount.value) {
    message.warning(`å¥–é¡¹åº“å­˜ä¸è¶³ï¼å½“å‰å¥–é¡¹å‰©ä½™ ${available} ä¸ªï¼Œæ— æ³•æŠ½å– ${drawCount.value} äºº`)
    return
  }

  // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æœªæŠ½å¥–çš„ç”¨æˆ·
  if (!currentCompanyCode.value) {
    return
  }
  const stats = await api.get(`/api/user-stats?company_code=${currentCompanyCode.value}`)

  if (!stats.undrawn_users || stats.undrawn_users === 0) {
    message.warning('æ‰€æœ‰ç”¨æˆ·éƒ½å·²ä¸­å¥–ï¼Œæš‚æ— å¯æŠ½å¥–ç”¨æˆ·ï¼')
    return
  }

  if (stats.undrawn_users < drawCount.value) {
    message.warning(`å‰©ä½™äººæ•°ä¸è¶³ï¼å½“å‰å‰©ä½™ ${stats.undrawn_users} äººï¼Œæ— æ³•æŠ½å– ${drawCount.value} äºº`)
    return
  }

  // è®¾ç½®æŠ½å¥–çŠ¶æ€
  drawing.value = true

  // å¯åŠ¨æ»šåŠ¨åŠ¨ç”»
  setTimeout(() => {
    startRolling()
  }, 100)
}

// åœæ­¢æŠ½å¥–å¹¶é€‰æ‹©ä¸­å¥–è€…
const handleStopDrawing = async () => {
  // åœæ­¢æ»šåŠ¨
  stopRolling()

  // è®¡ç®—é«˜äº®æ¡†ä¸­å¿ƒçš„ç”¨æˆ·
  const container = rollingContainerRef.value
  const track = rollingTrackRef.value

  if (!container || !track) {
    message.error('æ— æ³•è·å–æ»šåŠ¨ä½ç½®')
    drawing.value = false
    return
  }

  // æ£€æŸ¥æ˜¯å¦æœ‰ç”¨æˆ·æ•°æ®
  if (!displayUsers.value || displayUsers.value.length === 0) {
    message.error('ç”¨æˆ·æ•°æ®ä¸ºç©ºï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•')
    drawing.value = false
    return
  }

  // è·å–æ»šåŠ¨ä½ç½®å’Œå®¹å™¨å°ºå¯¸
  const scrollLeft = container.scrollLeft
  const containerWidth = container.clientWidth
  const centerPosition = scrollLeft + containerWidth / 2

  // è·å–æ‰€æœ‰ç”¨æˆ·é¡¹
  const userItems = track.querySelectorAll('.user-item')

  if (userItems.length === 0) {
    message.error('æœªæ‰¾åˆ°ç”¨æˆ·å…ƒç´ ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•')
    drawing.value = false
    return
  }

  let centeredUser = null
  let minDistance = Infinity
  let centeredIndex = -1

  // æ‰¾åˆ°æœ€æ¥è¿‘ä¸­å¿ƒçš„ç”¨æˆ·
  userItems.forEach((item, index) => {
    const itemLeft = item.offsetLeft
    const itemWidth = item.clientWidth
    const itemCenter = itemLeft + itemWidth / 2
    const distance = Math.abs(centerPosition - itemCenter)

    if (distance < minDistance) {
      minDistance = distance
      centeredIndex = index
      // ç¡®ä¿ç´¢å¼•åœ¨æœ‰æ•ˆèŒƒå›´å†…
      if (index < displayUsers.value.length) {
        centeredUser = displayUsers.value[index]
      }
    }
  })


  if (!centeredUser) {
    message.error('æ— æ³•ç¡®å®šä¸­å¥–ç”¨æˆ·')
    drawing.value = false
    return
  }

  try {
    // è°ƒç”¨åç«¯APIï¼ŒæŒ‡å®šä¸­å¥–ç”¨æˆ·
    if (!currentCompanyCode.value) {
      message.error('å…¬å¸ä¿¡æ¯å¼‚å¸¸ï¼Œè¯·é‡æ–°ç™»å½•')
      drawing.value = false
      return
    }

    const requestData = {
      level_id: selectedLevelId.value,
      count: drawCount.value
    }

    // å¦‚æœä¸­å¤®ç”¨æˆ·æ˜¯çœŸå®ç”¨æˆ·ï¼ˆä¸æ˜¯è™šæ‹Ÿç”¨æˆ·ï¼‰ï¼Œåˆ™ä¼ é€’user_phone
    if (centeredUser.phone && !centeredUser.phone.includes('****')) {
      requestData.user_phone = centeredUser.phone
    }

    const data = await api.post(`/api/draw?company_code=${currentCompanyCode.value}`, requestData)

    currentWinners.value = Array.isArray(data) ? data : [data]

    // ç›´æ¥æ˜¾ç¤ºç»“æœï¼Œä¸æ·»åŠ é¢å¤–æ•ˆæœ
    showResult.value = true

    await loadUserStats()
    await fetchDrawRecords()
    await fetchPrizeLevels()

    drawing.value = false
    showFlash.value = false
    showShake.value = false
    showConfetti.value = false
    message.success(`ğŸ‰ æˆåŠŸæŠ½å–${currentWinners.value.length}ä½ä¸­å¥–è€…ï¼`)
  } catch (error) {
    message.error(error.response?.data?.error || 'æŠ½å¥–å¤±è´¥')
    drawing.value = false
  }
}

// åˆ›å»ºäº”å½©çº¸å±‘æ•ˆæœ
const createConfetti = () => {
  const container = confettiRef.value
  if (!container) return

  const colors = ['#00fff5', '#ff00ff', '#ffcc00', '#b94fff', '#ff3366']
  container.innerHTML = ''

  for (let i = 0; i < 100; i++) {
    const confetti = document.createElement('div')
    confetti.className = 'confetti-piece'
    confetti.style.left = `${40 + Math.random() * 20}%`
    confetti.style.top = `${40 + Math.random() * 20}%`
    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)]
    confetti.style.transform = `rotate(${Math.random() * 360}deg)`

    // éšæœºçˆ†ç‚¸æ–¹å‘
    const angle = Math.random() * Math.PI * 2
    const velocity = 200 + Math.random() * 300
    const vx = Math.cos(angle) * velocity
    const vy = Math.sin(angle) * velocity

    confetti.style.setProperty('--vx', `${vx}px`)
    confetti.style.setProperty('--vy', `${vy}px`)

    container.appendChild(confetti)
  }
}

// é‡ç½®æŠ½å¥–
const resetDraw = () => {
  showResult.value = false
  currentWinners.value = []
  selectedLevelId.value = null
  drawCount.value = 1
  drawAttempted.value = false
}

// æ‰‹æœºå·è„±æ•
const maskPhone = (phone) => {
  if (!phone || phone.length < 7) return phone
  return phone.substring(0, 3) + '****' + phone.substring(7)
}

// è·å–å¥–é¡¹æ ‡ç­¾
const getLevelLabel = (name) => {
  if (name.includes('ä¸€ç­‰')) return 'ä¸€ç­‰å¥–'
  if (name.includes('äºŒç­‰')) return 'äºŒç­‰å¥–'
  if (name.includes('ä¸‰ç­‰')) return 'ä¸‰ç­‰å¥–'
  if (name.includes('å‚ä¸')) return 'å‚ä¸å¥–'
  return 'å¹¸è¿å¥–'
}

// è·å–å¥–é¡¹é¢œè‰²
const getLevelColor = (name) => {
  if (name.includes('ä¸€ç­‰')) return '#f50'
  if (name.includes('äºŒç­‰')) return '#fa8c16'
  if (name.includes('ä¸‰ç­‰')) return '#52c41a'
  if (name.includes('å‚ä¸')) return '#108ee9'
  return '#722ed1'
}

// è·å–åº“å­˜é¢œè‰²
const getStockColor = (level) => {
  const available = level.total_stock - level.used_stock
  const percent = (available / level.total_stock) * 100

  if (percent === 0) return '#ff4d4f'
  if (percent < 20) return '#faad14'
  if (percent < 50) return '#1890ff'
  return '#52c41a'
}

// è‡ªåŠ¨æ»šåŠ¨å‡½æ•°
const startAutoScroll = () => {
  if (autoScrollInterval.value || !timelineContainerRef.value) return

  autoScrollInterval.value = setInterval(() => {
    const container = timelineContainerRef.value
    if (!container) return

    // è·å–å½“å‰æ»šåŠ¨ä½ç½®
    const currentScroll = container.scrollLeft
    const maxScroll = container.scrollWidth - container.clientWidth

    // æ£€æŸ¥æ˜¯å¦åˆ°è¾¾æœ«å°¾
    if (currentScroll >= maxScroll - 1) {
      // ç¬é—´å›åˆ°å¼€å¤´ï¼ˆæ— ç¼å¾ªç¯ï¼‰
      container.scrollTo({ left: 0, behavior: 'auto' })
    } else {
      // å‘å·¦æ»šåŠ¨
      container.scrollBy({ left: scrollSpeed, behavior: 'smooth' })
    }
  }, scrollDelay)
}

const stopAutoScroll = () => {
  if (autoScrollInterval.value) {
    clearInterval(autoScrollInterval.value)
    autoScrollInterval.value = null
  }
}

const toggleAutoScroll = () => {
  if (isAutoScrolling.value) {
    stopAutoScroll()
    isAutoScrolling.value = false
  } else {
    startAutoScroll()
    isAutoScrolling.value = true
  }
}

const pauseAutoScroll = () => {
  if (isAutoScrolling.value) {
    stopAutoScroll()
  }
}

const resumeAutoScroll = () => {
  if (isAutoScrolling.value) {
    startAutoScroll()
  }
}

onMounted(async () => {
  // ä»URLå‚æ•°ä¸­è·å–å…¬å¸ä»£ç ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
  // æ³¨æ„ï¼šå‚æ•°å¯èƒ½åœ¨hashä¸­ï¼Œå¦‚ï¼š#/lottery?company=4000
  let urlCompanyCode = null

  // å…ˆå°è¯•ä»hashä¸­è·å–å‚æ•°
  if (window.location.hash.includes('?')) {
    const hashParts = window.location.hash.split('?')
    if (hashParts.length > 1) {
      const hashParams = new URLSearchParams(hashParts[1])
      urlCompanyCode = hashParams.get('company')
    }
  }

  // å¦‚æœhashä¸­æ²¡æœ‰ï¼Œå°è¯•ä»searchä¸­è·å–
  if (!urlCompanyCode && window.location.search) {
    const urlParams = new URLSearchParams(window.location.search)
    urlCompanyCode = urlParams.get('company')
  }

  if (urlCompanyCode) {
    currentCompanyCode.value = urlCompanyCode
    setCompanyCode(urlCompanyCode)
  }

  console.log('onMounted - URL hash:', window.location.hash)
  console.log('onMounted - URL search:', window.location.search)
  console.log('onMounted - extracted company code:', urlCompanyCode)
  console.log('onMounted - currentCompanyCode:', currentCompanyCode.value)

  // æ£€æŸ¥ç®¡ç†å‘˜ç™»å½•çŠ¶æ€
  const adminToken = localStorage.getItem('admin_token')
  const adminUserStr = localStorage.getItem('admin_user')
  if (adminToken && adminUserStr) {
    adminUser.value = JSON.parse(adminUserStr)
    adminLoggedIn.value = true
    currentUserRole.value = adminUser.value.user_type || 'admin'

    // ä»æ¢å¤çš„ç®¡ç†å‘˜ä¿¡æ¯ä¸­è·å–å…¬å¸ä»£ç ï¼ˆå¦‚æœURLä¸­æ²¡æœ‰æŒ‡å®šï¼‰
    if (!urlCompanyCode) {
      if (adminUser.value.company) {
        currentCompanyCode.value = adminUser.value.company.code
        setCompanyCode(adminUser.value.company.code)
      } else {
        // ç®¡ç†å‘˜æ²¡æœ‰å…³è”å…¬å¸ï¼Œä½¿ç”¨é»˜è®¤å…¬å¸
        currentCompanyCode.value = 'DEFAULT'
        setCompanyCode('DEFAULT')
      }
    }
  }

  // å·²ç™»å½•ï¼ˆç”¨æˆ·æˆ–ç®¡ç†å‘˜ï¼‰æ—¶åŠ è½½æ•°æ®
  if (userLoggedIn.value || adminLoggedIn.value) {
    await refreshConfig()
    await fetchPrizeLevels()
    await loadUserStats()
    await fetchDrawRecords()
  } else {
    // æœªç™»å½•æ—¶ä½¿ç”¨é»˜è®¤é…ç½®
    companyConfig.value = defaultConfig
    // æœªç™»å½•æ—¶ä¹Ÿè®¾ç½®é»˜è®¤å…¬å¸ä»£ç ï¼Œä»¥ä¾¿å¯ä»¥é¢„è§ˆå¥–é¡¹
    if (!currentCompanyCode.value) {
      currentCompanyCode.value = 'DEFAULT'
      setCompanyCode('DEFAULT')
    }
    // è·å–æ³¨å†ŒäºŒç»´ç ä¾›ç”¨æˆ·æ‰«æ
    await fetchRegisterQRCode()
  }

  createParticles()

  // è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªå¯ç”¨å¥–é¡¹
  if (availablePrizeLevels.value.length > 0) {
    selectedLevelId.value = availablePrizeLevels.value[0].id
  }

  // âœ… awaitå¼‚æ­¥å‡½æ•°åˆ›å»ºç”¨æˆ·åˆ—è¡¨
  await createDisplayUsers()

  // å¯åŠ¨ä¸­å¥–å†å²è‡ªåŠ¨æ»šåŠ¨
  if (drawRecords.value.length > 0) {
    setTimeout(() => {
      startAutoScroll()
    }, 100)
  }

  // æ·»åŠ classåˆ°bodyä»¥åº”ç”¨èƒŒæ™¯é¢œè‰²
  document.body.classList.add('lottery-active')
})

onUnmounted(() => {
  stopAutoScroll() // æ¸…ç†è‡ªåŠ¨æ»šåŠ¨å®šæ—¶å™¨
  stopRolling() // æ¸…ç†æ»šåŠ¨åŠ¨ç”»å®šæ—¶å™¨

  // ç§»é™¤bodyçš„class
  document.body.classList.remove('lottery-active')
})
</script>

<style scoped>
/* ============================================
   ç”¨æˆ·ç™»å½•ç•Œé¢
   ============================================ */

.login-qr-container {
  display: flex;
  gap: var(--spacing-2xl);
  align-items: stretch;
  max-width: 1000px;
  width: 100%;
  margin: 0 auto;
}

.user-login-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  background: var(--company-color-bg);
  padding: var(--spacing-lg);
}

.login-container {
  flex: 1;
  max-width: 450px;
  padding: var(--spacing-3xl);
  border-radius: var(--radius-2xl);
  border: 2px solid var(--neon-cyan);
  box-shadow: 0 0 50px rgba(0, 255, 245, 0.2);
}

.login-header {
  text-align: center;
  margin-bottom: var(--spacing-2xl);
}

.login-icon {
  font-size: 64px;
  margin-bottom: var(--spacing-lg);
  filter: drop-shadow(0 0 20px var(--neon-cyan));
  animation: float 3s ease-in-out infinite;
}

.login-title {
  font-size: var(--font-size-3xl);
  color: var(--text-primary);
  margin-bottom: var(--spacing-md);
  text-transform: uppercase;
  letter-spacing: 2px;
  text-shadow: 0 0 20px var(--neon-cyan);
}

.login-subtitle {
  font-size: var(--font-size-base);
  color: var(--text-secondary);
  margin: 0;
}

.login-type-tabs {
  display: flex;
  gap: var(--spacing-md);
  margin-bottom: var(--spacing-xl);
  background: rgba(255, 255, 255, 0.05);
  padding: var(--spacing-xs);
  border-radius: var(--radius-lg);
  border: 1px solid var(--border-color);
}

.login-type-tab {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: var(--spacing-sm);
  padding: var(--spacing-md) var(--spacing-lg);
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: all var(--transition-fast);
  background: transparent;
  border: 1px solid transparent;
}

.login-type-tab:hover {
  background: rgba(0, 255, 245, 0.1);
  border-color: rgba(0, 255, 245, 0.3);
}

.login-type-tab.active {
  background: var(--primary-gradient);
  border-color: var(--neon-cyan);
  box-shadow: 0 0 20px rgba(0, 255, 245, 0.3);
}

.login-type-tab .tab-icon {
  font-size: 20px;
}

.login-type-tab .tab-text {
  font-size: var(--font-size-base);
  font-weight: var(--font-weight-semibold);
  color: var(--text-primary);
}

.login-type-tab.active .tab-text {
  color: var(--bg-primary);
}

.login-form {
  margin-bottom: var(--spacing-xl);
}

/* è¡¨å•æ ‡ç­¾æ ·å¼ */
.form-label {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  color: var(--text-primary);
  font-size: var(--font-size-sm);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: var(--spacing-sm);
  font-weight: var(--font-weight-semibold);
}

.label-icon {
  color: var(--company-color);
  font-size: var(--font-size-lg);
}

/* è¾“å…¥æ¡†åŸºç¡€æ ·å¼ - ç™½è‰²èƒŒæ™¯ï¼Œæ¸…æ™°å¯è§ */
.neon-input :deep(.ant-input),
.neon-input :deep(.ant-input-password input) {
  background: rgba(255, 255, 255, 0.95) !important;
  border: 1px solid rgba(217, 217, 217, 0.8);
  border-radius: var(--radius-lg);
  color: #1a1a1a !important;
  transition: all var(--transition-base);
  position: relative;
  z-index: 10;
}

.neon-input :deep(.ant-input::placeholder),
.neon-input :deep(.ant-input-password input::placeholder) {
  color: #8c8c8c !important;
}

.neon-input :deep(.ant-input:focus),
.neon-input :deep(.ant-input-focused),
.neon-input :deep(.ant-input-password:focus),
.neon-input :deep(.ant-input-password-focused) {
  border-color: var(--company-color) !important;
  box-shadow: 0 0 0 2px rgba(0, 255, 245, 0.2);
  background: rgba(255, 255, 255, 1) !important;
}

/* å¯†ç è¾“å…¥æ¡†å®¹å™¨æ ·å¼ */
.neon-input :deep(.ant-input-password) {
  background: rgba(255, 255, 255, 0.95) !important;
  border: 1px solid rgba(217, 217, 217, 0.8);
  border-radius: var(--radius-lg);
  position: relative;
  z-index: 10;
}

.neon-input :deep(.ant-input-password:hover) {
  border-color: var(--company-color);
  background: rgba(255, 255, 255, 1) !important;
}

/* ç¡®ä¿å¯†ç è¾“å…¥æ¡†å†…çš„inputå…ƒç´ æ ·å¼æ­£ç¡® */
.neon-input :deep(.ant-input-password .ant-input) {
  background: transparent !important;
  color: #1a1a1a !important;
}

/* ä¿ç•™åŸæœ‰çš„è¡¨å•é¡¹æ ‡ç­¾æ ·å¼ï¼ˆç”¨äºå…¼å®¹ï¼‰ */
.login-form :deep(.ant-form-item-label > label) {
  color: var(--text-primary);
  font-weight: var(--font-weight-semibold);
}

.login-button {
  width: 100%;
  height: 48px;
  font-size: var(--font-size-lg);
  font-weight: var(--font-weight-semibold);
  color: var(--text-inverse);
  background: var(--primary-gradient);
  border: none;
  border-radius: var(--radius-lg);
  cursor: pointer;
  transition: all var(--transition-base);
  position: relative;
  overflow: hidden;
}

.login-button:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 10px 30px rgba(0, 255, 245, 0.4);
}

.login-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.login-tips {
  text-align: center;
  padding-top: var(--spacing-lg);
  border-top: 1px solid var(--border-color);
}

.tip-text {
  font-size: var(--font-size-sm);
  color: var(--text-secondary);
  margin: 0;
}

.logout-action {
  cursor: pointer;
  transition: all var(--transition-fast);
}

.logout-action:hover {
  opacity: 0.7;
}

/* ============================================
   ä¸»å®¹å™¨
   ============================================ */

.lottery-page {
  min-height: 100vh;
  background: var(--company-color-bg) !important;
  position: relative;
  overflow-x: hidden;
}

/* ç¡®ä¿bodyå’Œ#appèƒŒæ™¯ä¸å½±å“æŠ½å¥–é¡µé¢ */
body.lottery-page-active,
#app:has(.lottery-page) {
  background: var(--company-color-bg) !important;
}

/* é’ˆå¯¹æŠ½å¥–é¡µé¢çš„bodyèƒŒæ™¯ */
body {
  background: var(--company-color-bg);
}

/* è¦†ç›–App.vueä¸­çš„bodyæ ·å¼ */
body.lottery-active {
  background: var(--company-color-bg) !important;
}

.neon-background {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 0;
  overflow: hidden;
  pointer-events: none;
}

.gradient-orb {
  position: absolute;
  border-radius: 50%;
  filter: blur(100px);
  opacity: 0.2;
  animation: orbFloat 20s ease-in-out infinite;
}

.orb-cyan {
  width: 500px;
  height: 500px;
  background: var(--company-color);
  top: -150px;
  left: -150px;
}

.orb-magenta {
  width: 400px;
  height: 400px;
  background: var(--neon-magenta);
  bottom: -100px;
  right: -100px;
  animation-delay: 7s;
}

@keyframes orbFloat {
  0%, 100% {
    transform: translate(0, 0) scale(1);
  }
  50% {
    transform: translate(30px, -30px) scale(1.1);
  }
}

.grid-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-image:
    linear-gradient(var(--company-color-03) 1px, transparent 1px),
    linear-gradient(90deg, var(--company-color-03) 1px, transparent 1px);
  background-size: 50px 50px;
}

.particles {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}

.particle {
  position: absolute;
  width: 3px;
  height: 3px;
  background: var(--company-color);
  border-radius: 50%;
  opacity: 0.6;
  animation: particleFloat 10s ease-in-out infinite;
  box-shadow: 0 0 8px var(--company-color);
}

@keyframes particleFloat {
  0%, 100% {
    transform: translateY(0) translateX(0);
    opacity: 0;
  }
  10% {
    opacity: 0.6;
  }
  90% {
    opacity: 0.6;
  }
  100% {
    transform: translateY(-100vh) translateX(30px);
    opacity: 0;
  }
}

.lottery-content {
  position: relative;
  z-index: 1;
  max-width: 1600px;
  margin: 0 auto;
  padding: var(--spacing-3xl) var(--spacing-lg);
  display: grid;
  grid-template-columns: 1fr 380px;
  grid-template-rows: auto 1fr auto;
  gap: var(--spacing-2xl);
  min-height: calc(100vh - 140px);
  grid-template-areas:
    "stage controls"
    "stage controls"
    "timeline timeline";
}

/* ============================================
   é¡¶éƒ¨çŠ¶æ€æ 
   ============================================ */

.top-status-bar {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 100;
  padding: var(--spacing-md) var(--spacing-xl);
  background: rgba(10, 10, 15, 0.8);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border-color);
  box-shadow: 0 4px 20px var(--company-color-10);
}

.status-bar-content {
  max-width: 1600px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: var(--spacing-xl);
  flex-wrap: wrap;
}

.status-item {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
}

.status-icon {
  font-size: var(--font-size-xl);
}

.status-label {
  font-size: var(--font-size-sm);
  color: var(--text-secondary);
}

.status-value {
  font-size: var(--font-size-2xl);
  font-weight: var(--font-weight-bold);
  color: var(--company-color);
  min-width: 40px;
}

.status-divider {
  width: 1px;
  height: 24px;
  background: var(--border-color);
}

.status-indicator {
  padding: var(--spacing-xs) var(--spacing-md);
  border-radius: var(--radius-full);
  font-size: var(--font-size-xs);
  font-weight: var(--font-weight-semibold);
}

.status-indicator.live {
  background: var(--company-color-bg);
  color: var(--company-color);
  border: 1px solid var(--company-color-20);
  animation: pulse 2s ease-in-out infinite;
}

.status-actions {
  margin-left: auto;
}

.back-link-mini {
  color: var(--text-secondary);
  font-size: var(--font-size-sm);
  padding: var(--spacing-xs) var(--spacing-md);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-full);
  transition: all var(--transition-base);
}

.back-link-mini:hover {
  color: var(--company-color);
  border-color: var(--company-color);
  box-shadow: var(--glow-cyan);
}

/* ä¿®æ”¹å¯†ç æŒ‰é’®æ ·å¼ */
.top-status-bar .ant-btn {
  animation: none !important;
  transition: all 0.3s ease;
}

.top-status-bar .ant-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
}

/* ============================================
   å·¦ä¾§ä¸»èˆå°
   ============================================ */

.stage-area {
  grid-area: stage;
  display: flex;
  flex-direction: column;
}

.lottery-display {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
}

.mega-display {
  min-height: 60vh;
  padding: var(--spacing-3xl);
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden;
}

/* ============================================
   å€’è®¡æ—¶åœ†ç¯
   ============================================ */

.countdown-circle {
  position: absolute;
  bottom: var(--spacing-xl);
  right: var(--spacing-xl);
  width: 120px;
  height: 120px;
  z-index: 10;
}

.countdown-svg {
  width: 100%;
  height: 100%;
  transform: rotate(-90deg);
}

.countdown-track {
  stroke: rgba(255, 255, 255, 0.1);
}

.countdown-progress {
  stroke-linecap: round;
  transition: stroke-dasharray 0.3s ease, stroke 0.3s ease;
  animation: countdownPulse 1s ease-in-out infinite;
}

@keyframes countdownPulse {
  0%, 100% {
    filter: drop-shadow(0 0 10px currentColor);
  }
  50% {
    filter: drop-shadow(0 0 20px currentColor);
  }
}

.countdown-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: var(--font-size-4xl);
  font-weight: var(--font-weight-bold);
  color: var(--text-primary);
  text-shadow: 0 0 20px currentColor;
}

/* ============================================
   æŠ½å¥–æ»šåŠ¨åŠ¨ç”»
   ============================================ */

.drawing-animation {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}

.rolling-container {
  width: 100%;
  max-width: 800px;
  overflow-x: auto;
  overflow-y: hidden;
  position: relative;
  scrollbar-width: none; /* Firefox */
  -ms-overflow-style: none; /* IE and Edge */
}

.rolling-container::-webkit-scrollbar {
  display: none; /* Chrome, Safari, Opera */
}

.rolling-track {
  display: flex;
  gap: var(--spacing-xl);
  padding: 0 var(--spacing-xl);
  will-change: transform;
  min-width: max-content;
}

.user-item {
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: var(--spacing-lg);
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: var(--radius-lg);
  backdrop-filter: blur(10px);
  transition: all 0.3s ease;
}

.user-name {
  font-size: var(--font-size-3xl);
  color: var(--text-primary);
  margin-bottom: var(--spacing-xs);
  text-shadow: 0 0 20px var(--company-color);
  font-weight: var(--font-weight-bold);
  letter-spacing: 1px;
}

.user-phone {
  font-size: var(--font-size-base);
  color: var(--text-secondary);
}

/* é«˜äº®æ¡† */
.highlight-frame {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 300px;
  height: 200px;
  pointer-events: none;
  z-index: 10;
}

.highlight-indicator {
  width: 100%;
  height: 100%;
  border: 4px solid var(--neon-yellow);
  border-radius: var(--radius-2xl);
  box-shadow: 0 0 30px rgba(255, 204, 0, 0.5),
              inset 0 0 30px rgba(255, 204, 0, 0.2);
  animation: highlightPulse 1.5s ease-in-out infinite;
}

@keyframes highlightPulse {
  0%, 100% {
    box-shadow: 0 0 30px rgba(255, 204, 0, 0.5),
                inset 0 0 30px rgba(255, 204, 0, 0.2);
  }
  50% {
    box-shadow: 0 0 50px rgba(255, 204, 0, 0.8),
                inset 0 0 50px rgba(255, 204, 0, 0.3);
  }
}

.drawing-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: radial-gradient(circle, transparent 0%, rgba(0, 0, 0, 0.5) 100%);
  pointer-events: none;
}

/* ç­‰å¾…çŠ¶æ€è¦†ç›–å±‚ */
.waiting-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: radial-gradient(circle, rgba(0, 0, 0, 0.3) 0%, rgba(0, 0, 0, 0.7) 100%);
  backdrop-filter: blur(10px);
  z-index: 20;
  pointer-events: none;
}

.waiting-overlay .waiting-icon {
  font-size: 80px;
  margin-bottom: var(--spacing-xl);
  animation: iconBounce 2s ease-in-out infinite;
}

.waiting-overlay .waiting-title {
  font-size: var(--font-size-4xl);
  color: var(--text-primary);
  margin-bottom: var(--spacing-md);
  text-shadow: 0 0 20px var(--company-color);
}

.waiting-overlay .waiting-desc {
  font-size: var(--font-size-lg);
  color: var(--text-secondary);
}

@keyframes iconBounce {
  0%, 100% {
    transform: translateY(0);
  }
  50% {
    transform: translateY(-10px);
  }
}

/* ============================================
   å³ä¾§æ§åˆ¶é¢æ¿
   ============================================ */

.controls-area {
  grid-area: controls;
}

.control-panel {
  position: sticky;
  top: 100px;
  max-height: calc(100vh - 120px);
  overflow-y: auto;
  background: rgba(26, 26, 36, 0.8);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-radius: var(--radius-2xl);
  padding: var(--spacing-xl);
  border: 1px solid var(--border-color);
  box-shadow: var(--shadow-2);
}

.control-panel::-webkit-scrollbar {
  width: 6px;
}

.control-panel::-webkit-scrollbar-track {
  background: var(--bg-secondary);
  border-radius: var(--radius-full);
}

.control-panel::-webkit-scrollbar-thumb {
  background: var(--company-color);
  border-radius: var(--radius-full);
}

.config-header {
  margin-bottom: var(--spacing-lg);
  padding-bottom: var(--spacing-md);
  border-bottom: 1px solid var(--border-color);
}

.config-title {
  font-size: var(--font-size-xl);
  color: var(--company-color);
  letter-spacing: 1px;
  margin: 0;
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
}

/* è¡¨å•å®¹å™¨ */
.config-form {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-lg);
}

/* è¡¨å•ç»„ */
.form-group {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-sm);
}

.form-label {
  font-size: var(--font-size-sm);
  color: var(--text-secondary);
  font-weight: var(--font-weight-semibold);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: var(--spacing-xs);
}

/* ä¸‹æ‹‰é€‰æ‹©æ¡† */
.neon-select {
  width: 100%;
}

.neon-select .ant-select-selector {
  background: rgba(255, 255, 255, 0.05) !important;
  border: 1px solid var(--border-color) !important;
  border-radius: var(--radius-base) !important;
  transition: all var(--transition-base);
}

.neon-select .ant-select-selector:hover {
  border-color: var(--company-color) !important;
  box-shadow: 0 0 10px var(--company-color-20);
}

.neon-select.ant-select-focused .ant-select-selector {
  border-color: var(--company-color) !important;
  box-shadow: 0 0 20px var(--company-color-30);
}

.level-option {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: var(--spacing-xs) 0;
}

.level-main {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
}

.level-name {
  font-size: var(--font-size-base);
  font-weight: var(--font-weight-semibold);
}

.level-tag {
  font-size: var(--font-size-xs);
}

.level-stock {
  font-size: var(--font-size-sm);
  color: var(--text-secondary);
}

.stock-text strong {
  color: var(--success-color);
}

/* è¾“å…¥æ¡† */
.neon-input-number {
  width: 100%;
}

.neon-input-number .ant-input-number {
  background: rgba(255, 255, 255, 0.05) !important;
  border: 1px solid var(--border-color) !important;
  border-radius: var(--radius-base) !important;
}

.neon-input-number .ant-input-number:hover {
  border-color: var(--company-color) !important;
}

.neon-input-number.ant-input-number-focused {
  border-color: var(--company-color) !important;
  box-shadow: 0 0 20px var(--company-color-30);
}

/* äººæ•°é€‰æ‹©å™¨ */
.count-selector {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-md);
}

.quick-counts {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: var(--spacing-sm);
}

.quick-count-btn {
  padding: var(--spacing-sm) var(--spacing-md);
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-base);
  color: var(--text-primary);
  cursor: pointer;
  transition: all var(--transition-base);
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-medium);
  text-align: center;
}

.quick-count-btn:hover:not(:disabled) {
  background: var(--company-color-15);
  border-color: var(--company-color);
  color: var(--company-color);
  transform: translateY(-2px);
  box-shadow: 0 4px 20px var(--company-color-20);
}

.quick-count-btn.active {
  background: var(--primary-gradient);
  border-color: transparent;
  color: var(--text-inverse);
  box-shadow: 0 0 20px var(--company-color-40);
  font-weight: var(--font-weight-bold);
}

.quick-count-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

/* æç¤ºä¿¡æ¯ */
.form-tip {
  font-size: var(--font-size-xs);
  color: var(--text-tertiary);
  padding: var(--spacing-sm) var(--spacing-md);
  background: var(--company-color-bg);
  border-radius: var(--radius-base);
  border-left: 3px solid var(--company-color);
  line-height: 1.5;
}

.form-tip strong {
  color: var(--success-color);
  font-weight: var(--font-weight-bold);
}

.form-error {
  font-size: var(--font-size-xs);
  color: var(--error-color);
  margin-top: var(--spacing-xs);
  padding: var(--spacing-xs) var(--spacing-sm);
  background: rgba(255, 51, 102, 0.1);
  border-radius: var(--radius-sm);
}

/* ç”¨æˆ·ä¿¡æ¯é¢æ¿ */
.user-info-panel {
  background: rgba(26, 26, 36, 0.6);
}

.user-info-content {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-lg);
}

.info-item {
  display: flex;
  align-items: center;
  gap: var(--spacing-md);
  padding: var(--spacing-md);
  background: rgba(0, 255, 245, 0.05);
  border: 1px solid rgba(0, 255, 245, 0.2);
  border-radius: var(--radius-lg);
  transition: all var(--transition-fast);
}

.info-item:hover {
  background: rgba(0, 255, 245, 0.1);
  border-color: var(--company-color);
  box-shadow: 0 0 20px var(--company-color-20);
}

.info-icon {
  font-size: 32px;
  filter: drop-shadow(0 0 10px var(--company-color));
}

.info-details {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: var(--spacing-xs);
}

.info-label {
  font-size: var(--font-size-sm);
  color: var(--text-secondary);
  font-weight: var(--font-weight-medium);
}

.info-value {
  font-size: var(--font-size-2xl);
  color: var(--company-color);
  font-weight: var(--font-weight-bold);
}

.user-notice-banner {
  display: flex;
  align-items: center;
  gap: var(--spacing-md);
  padding: var(--spacing-lg);
  background: rgba(255, 193, 7, 0.1);
  border: 1px solid rgba(255, 193, 7, 0.3);
  border-radius: var(--radius-lg);
  animation: pulse 2s ease-in-out infinite;
}

.user-notice-banner .notice-icon {
  font-size: 40px;
  animation: bounce 1s ease-in-out infinite;
}

.user-notice-banner .notice-text {
  flex: 1;
  font-size: var(--font-size-base);
  color: var(--text-primary);
  margin: 0;
  line-height: 1.6;
}

@keyframes pulse {
  0%, 100% {
    box-shadow: 0 0 20px rgba(255, 193, 7, 0.2);
  }
  50% {
    box-shadow: 0 0 30px rgba(255, 193, 7, 0.4);
  }
}

@keyframes bounce {
  0%, 100% {
    transform: translateY(0);
  }
  50% {
    transform: translateY(-10px);
  }
}

/* æŠ½å¥–æŒ‰é’®åŒºåŸŸ */
.draw-actions {
  margin-top: var(--spacing-lg);
}

.mega-draw-btn {
  width: 100%;
  height: 80px;
  font-size: var(--font-size-2xl) !important;
  font-weight: var(--font-weight-bold);
  letter-spacing: 1px;
  background: var(--primary-gradient);
  color: var(--text-inverse);
  border: none;
  border-radius: var(--radius-xl);
  cursor: pointer;
  box-shadow: 0 0 40px var(--company-color-30);
  transition: all var(--transition-base);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: var(--spacing-sm);
  position: relative;
  overflow: hidden;
}

.mega-draw-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(
    90deg,
    transparent,
    rgba(255, 255, 255, 0.3),
    transparent
  );
  transition: left 0.6s;
}

.mega-draw-btn:hover::before {
  left: 100%;
}

.mega-draw-btn:hover:not(:disabled) {
  transform: translateY(-4px) scale(1.02);
  box-shadow: 0 0 60px var(--company-color-50), 0 0 100px rgba(185, 79, 255, 0.3);
}

.mega-draw-btn:active:not(:disabled) {
  transform: translateY(-2px) scale(0.98);
}

.mega-draw-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

.mega-draw-btn.drawing {
  animation: buttonPulse 1.5s ease-in-out infinite;
}

@keyframes buttonPulse {
  0%, 100% {
    box-shadow: 0 0 40px var(--company-color-30);
  }
  50% {
    box-shadow: 0 0 60px var(--company-color-60);
  }
}

.button-spinner {
  width: 28px;
  height: 28px;
  border: 3px solid transparent;
  border-top-color: var(--text-inverse);
  border-right-color: var(--text-inverse);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

/* ============================================
   åº•éƒ¨æ—¶é—´çº¿
   ============================================ */

.timeline-area {
  grid-area: timeline;
}

.timeline-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--spacing-lg);
}

.timeline-title {
  font-size: var(--font-size-xl);
  color: var(--text-primary);
  margin: 0;
}

.timeline-controls {
  display: flex;
  align-items: center;
  gap: var(--spacing-md);
}

.scroll-toggle {
  padding: var(--spacing-xs) var(--spacing-sm);
  background: var(--company-color-10);
  border: 1px solid var(--company-color);
  border-radius: var(--radius-base);
  color: var(--company-color);
  cursor: pointer;
  transition: all var(--transition-base);
  font-size: var(--font-size-lg);
  line-height: 1;
}

.scroll-toggle:hover {
  background: var(--company-color-20);
  box-shadow: var(--glow-cyan);
  transform: scale(1.05);
}

.scroll-toggle.paused {
  background: rgba(255, 204, 0, 0.1);
  border-color: var(--neon-yellow);
  color: var(--neon-yellow);
}

.scroll-toggle.paused:hover {
  background: rgba(255, 204, 0, 0.2);
  box-shadow: var(--glow-yellow);
}

.winners-timeline {
  overflow-x: auto;
  overflow-y: hidden;
  padding: var(--spacing-md) 0;
  scrollbar-width: thin;
  scrollbar-color: var(--company-color) var(--bg-secondary);
  position: relative;
}

.winners-timeline::-webkit-scrollbar {
  height: 8px;
}

.winners-timeline::-webkit-scrollbar-track {
  background: var(--bg-secondary);
  border-radius: var(--radius-full);
}

.winners-timeline::-webkit-scrollbar-thumb {
  background: var(--company-color);
  border-radius: var(--radius-full);
}

.timeline-track {
  display: flex;
  gap: var(--spacing-md);
  padding: 0 var(--spacing-md);
  scroll-behavior: smooth;
}

.timeline-item {
  flex-shrink: 0;
  width: 280px;
  display: flex;
  align-items: center;
  gap: var(--spacing-md);
  padding: var(--spacing-md);
  border-radius: var(--radius-lg);
  border: 1px solid var(--border-color);
  transition: all var(--transition-base);
  animation: slideInRight 0.5s ease-out;
  cursor: pointer;
}

.timeline-item:hover {
  transform: translateY(-4px) rotateX(5deg);
  border-color: var(--neon-yellow);
  box-shadow: 0 0 30px rgba(255, 204, 0, 0.3);
}

/* æ»šåŠ¨æ—¶çš„äº¤äº’åé¦ˆ */
.winners-timeline:hover .timeline-track {
  scroll-behavior: smooth;
}

/* æ»šåŠ¨æ¡æ ·å¼ä¼˜åŒ– */
.winners-timeline::-webkit-scrollbar {
  height: 8px;
}

.winners-timeline::-webkit-scrollbar-track {
  background: var(--bg-secondary);
  border-radius: var(--radius-full);
}

.winners-timeline::-webkit-scrollbar-thumb {
  background: var(--company-color);
  border-radius: var(--radius-full);
  transition: background var(--transition-base);
}

.winners-timeline::-webkit-scrollbar-thumb:hover {
  background: var(--neon-magenta);
}

/* è‡ªåŠ¨æ»šåŠ¨æŒ‡ç¤ºå™¨ */
.winners-timeline::before {
  content: '';
  position: absolute;
  top: var(--spacing-sm);
  left: 50%;
  transform: translateX(-50%);
  width: 40px;
  height: 2px;
  background: var(--company-color);
  border-radius: var(--radius-full);
  opacity: 0;
  transition: opacity var(--transition-base);
}

.winners-timeline:hover::before {
  opacity: 0.5;
}

.timeline-avatar {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: var(--primary-gradient);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: var(--font-size-xl);
  color: var(--text-inverse);
  flex-shrink: 0;
}

.timeline-info {
  flex: 1;
  min-width: 0;
}

.timeline-name {
  font-size: var(--font-size-base);
  color: var(--text-primary);
  margin-bottom: var(--spacing-xs);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.timeline-phone {
  font-size: var(--font-size-xs);
  color: var(--text-secondary);
}

.timeline-prize {
  text-align: right;
}

.timeline-level {
  font-size: var(--font-size-sm);
  color: var(--neon-yellow);
  font-weight: var(--font-weight-bold);
}

.timeline-prize-name {
  font-size: var(--font-size-xs);
  color: var(--text-secondary);
  margin-top: 2px;
}

/* ============================================
   ç‰¹æ•ˆï¼šå±å¹•é—ªå…‰
   ============================================ */

.screen-flash {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: white;
  z-index: 9999;
  pointer-events: none;
  animation: flashBang 0.5s ease-out forwards;
}

@keyframes flashBang {
  0% {
    opacity: 1;
  }
  100% {
    opacity: 0;
  }
}

/* ============================================
   ç‰¹æ•ˆï¼šç›¸æœºéœ‡åŠ¨
   ============================================ */

.shake-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  z-index: 9998;
  pointer-events: none;
  animation: cameraShake 0.5s cubic-bezier(.36, .07, .19, .97) both;
}

@keyframes cameraShake {
  10%, 90% { transform: translate3d(-2px, 0, 0); }
  20%, 80% { transform: translate3d(4px, 0, 0); }
  30%, 50%, 70% { transform: translate3d(-8px, 0, 0); }
  40%, 60% { transform: translate3d(8px, 0, 0); }
}

/* ============================================
   ç‰¹æ•ˆï¼šäº”å½©çº¸å±‘
   ============================================ */

.confetti-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  z-index: 9997;
  pointer-events: none;
  overflow: hidden;
}

.confetti-piece {
  position: absolute;
  width: 10px;
  height: 10px;
  top: 50%;
  left: 50%;
  animation: confettiExplode 3s ease-out forwards;
}

@keyframes confettiExplode {
  0% {
    transform: translate(0, 0) rotate(0deg);
    opacity: 1;
  }
  100% {
    transform: translate(var(--vx), var(--vy)) rotate(720deg);
    opacity: 0;
  }
}

/* ============================================
   å·¨å‹ä¸­å¥–å¡ç‰‡
   ============================================ */

.winner-card-mega {
  min-height: 400px;
  padding: 60px;
  background: var(--company-color-bg);
  border: 4px solid var(--neon-yellow);
  box-shadow: 0 0 80px var(--neon-yellow),
              0 0 120px var(--neon-magenta);
  animation: winnerPulse 2s ease-in-out infinite;
}

@keyframes winnerPulse {
  0%, 100% {
    transform: scale(1);
    box-shadow: 0 0 80px var(--neon-yellow);
  }
  50% {
    transform: scale(1.02);
    box-shadow: 0 0 120px var(--neon-yellow),
                0 0 160px var(--neon-magenta);
  }
}

.winner-card-mega .winner-avatar {
  width: 120px;
  height: 120px;
  font-size: var(--font-size-4xl);
  position: relative;
  overflow: hidden;
}

.winner-card-mega .winner-avatar::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: linear-gradient(
    45deg,
    transparent 30%,
    rgba(255, 204, 0, 0.8) 50%,
    transparent 70%
  );
  animation: goldShine 2s linear infinite;
}

@keyframes goldShine {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.winner-card-mega .winner-name {
  font-size: var(--font-size-3xl);
}

.winner-card-mega .winner-phone {
  font-size: var(--font-size-lg);
}

.winner-card-mega .prize-level {
  font-size: var(--font-size-2xl);
}

.winner-card-mega .prize-name {
  font-size: var(--font-size-base);
}

/* å·¨å‹æŒ‰é’® */
.mega-btn {
  height: 70px;
  font-size: var(--font-size-2xl) !important;
}

.mega-draw-btn {
  height: 80px;
  font-size: var(--font-size-3xl) !important;
}

/* åœæ­¢æŠ½å¥–æŒ‰é’® */
.stop-draw-btn {
  position: absolute;
  bottom: 40px;
  left: 50%;
  transform: translateX(-50%);
  min-width: 280px;
  height: 70px;
  padding: 0 var(--spacing-2xl);
  background: linear-gradient(135deg, #ff3366 0%, #ff6b6b 100%);
  border: 3px solid #ff3366;
  border-radius: var(--radius-xl);
  color: white;
  font-size: var(--font-size-2xl);
  font-weight: var(--font-weight-bold);
  letter-spacing: 2px;
  cursor: pointer;
  transition: all var(--transition-base);
  box-shadow: 0 0 30px rgba(255, 51, 102, 0.4),
              0 0 60px rgba(255, 51, 102, 0.2);
  z-index: 100;
  animation: stopButtonPulse 1.5s ease-in-out infinite;
}

.stop-draw-btn:hover {
  transform: translateX(-50%) translateY(-4px) scale(1.05);
  box-shadow: 0 0 50px rgba(255, 51, 102, 0.6),
              0 0 100px rgba(255, 51, 102, 0.4);
  border-color: #ff6b6b;
}

.stop-draw-btn:active {
  transform: translateX(-50%) translateY(-2px) scale(1.02);
}

@keyframes stopButtonPulse {
  0%, 100% {
    box-shadow: 0 0 30px rgba(255, 51, 102, 0.4),
                0 0 60px rgba(255, 51, 102, 0.2);
  }
  50% {
    box-shadow: 0 0 50px rgba(255, 51, 102, 0.6),
                0 0 100px rgba(255, 51, 102, 0.4);
  }
}

/* ç»§ç»­æŠ½å¥–æŒ‰é’® */
.continue-draw-btn {
  position: relative;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: var(--spacing-md);
  min-width: 240px;
  height: 64px;
  padding: 0 var(--spacing-2xl);
  margin-top: var(--spacing-xl);
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border: none;
  border-radius: var(--radius-xl);
  color: white;
  font-size: var(--font-size-xl);
  font-weight: var(--font-weight-bold);
  letter-spacing: 1px;
  cursor: pointer;
  transition: all var(--transition-base);
  box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4),
              0 0 0 0 rgba(102, 126, 234, 0);
  overflow: hidden;
}

.continue-draw-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
  opacity: 0;
  transition: opacity var(--transition-base);
  z-index: 0;
}

.continue-draw-btn:hover::before {
  opacity: 1;
}

.continue-draw-btn .btn-icon {
  position: relative;
  z-index: 1;
  font-size: var(--font-size-2xl);
  animation: bounce 2s ease-in-out infinite;
}

.continue-draw-btn .btn-text {
  position: relative;
  z-index: 1;
}

.continue-draw-btn .btn-arrow {
  position: relative;
  z-index: 1;
  font-size: var(--font-size-2xl);
  transition: transform var(--transition-base);
}

.continue-draw-btn:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 32px rgba(102, 126, 234, 0.6),
              0 0 0 8px rgba(102, 126, 234, 0.1);
}

.continue-draw-btn:hover .btn-arrow {
  transform: translateX(8px);
}

.continue-draw-btn:active {
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(102, 126, 234, 0.5);
}

@keyframes bounce {
  0%, 100% {
    transform: translateY(0);
  }
  50% {
    transform: translateY(-4px);
  }
}

/* æŒ‰é’®å…‰æ•ˆåŠ¨ç”» */
.continue-draw-btn::after {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: linear-gradient(
    to right,
    transparent,
    rgba(255, 255, 255, 0.3),
    transparent
  );
  transform: rotate(45deg);
  animation: shine 3s ease-in-out infinite;
  z-index: 1;
}

@keyframes shine {
  0% {
    transform: translateX(-100%) rotate(45deg);
  }
  50%,
  100% {
    transform: translateX(100%) rotate(45deg);
  }
}

/* ============================================
   å“åº”å¼è®¾è®¡
   ============================================ */

@media (max-width: 1199px) {
  .lottery-content {
    display: flex;
    flex-direction: column;
    padding: 100px var(--spacing-md) var(--spacing-lg);
  }

  .control-panel {
    position: static;
    max-height: none;
  }

  .mega-display {
    min-height: 40vh;
  }

  .winner-card-mega {
    min-height: auto;
    padding: var(--spacing-xl);
  }

  .winner-card-mega .winner-avatar {
    width: 80px;
    height: 80px;
    font-size: var(--font-size-2xl);
  }

  .status-bar-content {
    gap: var(--spacing-md);
  }

  .status-value {
    font-size: var(--font-size-xl);
  }

  .back-link-mini {
    display: none;
  }
}

@media (max-width: 768px) {
  .lottery-content {
    padding: 90px var(--spacing-sm) var(--spacing-md);
  }

  .mega-display {
    min-height: 350px;
    padding: var(--spacing-xl);
  }

  .countdown-circle {
    width: 80px;
    height: 80px;
  }

  .countdown-text {
    font-size: var(--font-size-2xl);
  }

  .timeline-item {
    width: 250px;
  }

  .mega-draw-btn {
    height: 60px;
    font-size: var(--font-size-xl) !important;
  }
}

/* ============================================
   å‡å°‘åŠ¨ç”»ï¼ˆæ— éšœç¢ï¼‰
   ============================================ */

@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }

  .particle {
    display: none;
  }
}

/* ============================================
   æ‰«ç å‚ä¸å¡ç‰‡
   ============================================ */

.qr-register-card {
  flex: 1;
  max-width: 450px;
  padding: var(--spacing-3xl);
  border-radius: var(--radius-2xl);
  border: 2px solid #667eea;
  box-shadow: 0 0 50px rgba(102, 126, 234, 0.3);
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px);
}

.qr-header {
  text-align: center;
  margin-bottom: var(--spacing-2xl);
}

.qr-icon {
  font-size: 64px;
  margin-bottom: var(--spacing-md);
  filter: drop-shadow(0 0 20px rgba(102, 126, 234, 0.5));
  animation: float 3s ease-in-out infinite;
}

.qr-title {
  font-size: var(--font-size-3xl);
  color: #1a1a1a;
  margin-bottom: var(--spacing-sm);
  text-transform: uppercase;
  letter-spacing: 2px;
}

.qr-subtitle {
  font-size: var(--font-size-base);
  color: #666;
  margin: 0;
}

.qr-loading {
  text-align: center;
  padding: var(--spacing-3xl);
  color: #666;
}

.qr-content {
  text-align: center;
}

.qr-image {
  width: 100%;
  max-width: 280px;
  height: auto;
  border-radius: var(--radius-lg);
  border: 4px solid #667eea;
  padding: 16px;
  background: white;
  box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2);
  margin-bottom: var(--spacing-xl);
}

.qr-instructions {
  text-align: left;
  padding: var(--spacing-lg);
  background: rgba(102, 126, 234, 0.05);
  border-radius: var(--radius-lg);
  border: 1px solid rgba(102, 126, 234, 0.2);
}

.instruction-step {
  display: flex;
  align-items: center;
  gap: var(--spacing-md);
  margin: var(--spacing-md) 0;
  font-size: var(--font-size-base);
  color: #333;
  line-height: 1.6;
}

.step-number {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  font-weight: bold;
  flex-shrink: 0;
  font-size: var(--font-size-sm);
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 968px) {
  .login-qr-container {
    flex-direction: column;
    gap: var(--spacing-lg);
  }

  .login-container,
  .qr-register-card {
    max-width: 100%;
  }
}
</style>
